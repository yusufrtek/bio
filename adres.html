<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firebase Takım + Sayı Demo</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 900px; margin: 24px auto; padding: 0 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    input, select, button { padding: 10px; font-size: 14px; }
    button { cursor: pointer; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin-top: 14px; }
    .muted { color: #666; }
    .teams { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .teamTitle { display:flex; justify-content:space-between; align-items:center; }
    ul { margin: 8px 0 0; padding-left: 18px; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>

  <h1>Firebase Demo: Takım Kurma + Sayı Ekleme (Sıralı)</h1>
  <p class="muted">
    Bu sayfa Firestore'a yazar/okur. Herkes aynı sayfayı açarsa anlık güncellenir.
  </p>

  <div class="card">
    <h2>1) Takım oluştur</h2>
    <div class="row">
      <input id="teamName" placeholder="Takım adı (örn: Mavi)" />
      <button id="createTeamBtn">Takım Oluştur</button>
    </div>
    <p class="muted">Oluşturulan takım Firestore'a <code>teams</code> koleksiyonuna kaydolur.</p>
  </div>

  <div class="card">
    <h2>2) Takıma sayı ekle</h2>
    <div class="row">
      <select id="teamSelect"></select>
      <input id="numberInput" type="number" placeholder="Sayı (örn: 42)" />
      <button id="addNumberBtn">Sayı Ekle</button>
    </div>
    <p class="muted">Sayılar <code>teams/{teamId}/numbers</code> alt koleksiyonuna kaydolur.</p>
  </div>

  <div class="card">
    <h2>3) Takımlar ve sıralı sayıları (anlık)</h2>
    <div id="teamsContainer" class="teams"></div>
  </div>

  <script type="module">
    // --- Firebase imports (senin verdiğin yapıya uygun) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    // Analytics şart değil; demo için kullanmıyoruz.
    // import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";

    // Firestore imports
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      setDoc,
      serverTimestamp,
      onSnapshot,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // --- Senin config'in ---
    const firebaseConfig = {
      apiKey: "AIzaSyCbBh9ulc4_tds31MsDbiSgaHPUU3l0Qx4",
      authDomain: "maps-52b00.firebaseapp.com",
      projectId: "maps-52b00",
      storageBucket: "maps-52b00.firebasestorage.app",
      messagingSenderId: "485125559932",
      appId: "1:485125559932:web:7d304f3f2cda4ef4c21bf9",
      measurementId: "G-YHHXDYCCG7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- UI refs ---
    const teamNameEl = document.getElementById("teamName");
    const createTeamBtn = document.getElementById("createTeamBtn");
    const teamSelect = document.getElementById("teamSelect");
    const numberInput = document.getElementById("numberInput");
    const addNumberBtn = document.getElementById("addNumberBtn");
    const teamsContainer = document.getElementById("teamsContainer");

    // Takımlar state'i (id -> {name})
    const teamsMap = new Map();

    // 1) Takım oluştur
    createTeamBtn.addEventListener("click", async () => {
      const name = teamNameEl.value.trim();
      if (!name) return alert("Takım adı yaz.");

      // Aynı isimli takım oluşturmayı basitçe engelleyelim:
      // (Gerçekte daha sağlam kontrol yapılır)
      for (const [, t] of teamsMap) {
        if (t.name.toLowerCase() === name.toLowerCase()) {
          return alert("Bu isimde takım zaten var.");
        }
      }

      // teams koleksiyonuna yeni takım
      const teamRef = await addDoc(collection(db, "teams"), {
        name,
        createdAt: serverTimestamp(),
      });

      teamNameEl.value = "";
      // UI anlık dinlemede zaten güncellenecek
    });

    // 2) Takıma sayı ekle
    addNumberBtn.addEventListener("click", async () => {
      const teamId = teamSelect.value;
      if (!teamId) return alert("Önce bir takım seç.");
      const n = Number(numberInput.value);
      if (!Number.isFinite(n)) return alert("Geçerli bir sayı gir.");

      await addDoc(collection(db, "teams", teamId, "numbers"), {
        value: n,
        createdAt: serverTimestamp(),
      });

      numberInput.value = "";
    });

    // --- Takımları anlık dinle ---
    onSnapshot(collection(db, "teams"), (snap) => {
      teamsMap.clear();
      snap.forEach((d) => teamsMap.set(d.id, d.data()));

      // Select'i doldur
      teamSelect.innerHTML = "";
      if (teamsMap.size === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Önce takım oluştur";
        teamSelect.appendChild(opt);
      } else {
        for (const [id, team] of teamsMap) {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = team.name;
          teamSelect.appendChild(opt);
        }
      }

      // Kartları çiz (numbers dinleyicileri de team bazlı kurulacak)
      renderTeams();
    });

    // teamId -> unsubscribe
    const numbersUnsubs = new Map();
    // teamId -> array of numbers
    const teamNumbers = new Map();

    function renderTeams() {
      teamsContainer.innerHTML = "";

      // Eski dinleyicileri kaldır (takımlar değiştiyse)
      for (const [teamId, unsub] of numbersUnsubs) {
        if (!teamsMap.has(teamId)) {
          unsub();
          numbersUnsubs.delete(teamId);
          teamNumbers.delete(teamId);
        }
      }

      // Her takım için kart + numbers realtime dinleme
      for (const [teamId, team] of teamsMap) {
        // kart
        const card = document.createElement("div");
        card.className = "card";

        const header = document.createElement("div");
        header.className = "teamTitle";

        const title = document.createElement("h3");
        title.textContent = team.name;

        const count = document.createElement("span");
        count.className = "muted";
        count.textContent = "Yükleniyor...";

        header.appendChild(title);
        header.appendChild(count);

        const list = document.createElement("ul");

        card.appendChild(header);
        card.appendChild(list);
        teamsContainer.appendChild(card);

        // numbers dinleyicisi yoksa kur
        if (!numbersUnsubs.has(teamId)) {
          const q = query(
            collection(db, "teams", teamId, "numbers"),
            // createdAt ile çekiyoruz, sonra JS'te value'ya göre sıralıyoruz
            orderBy("createdAt", "desc")
          );

          const unsub = onSnapshot(q, (snap) => {
            const nums = [];
            snap.forEach((d) => {
              const data = d.data();
              if (typeof data.value === "number") nums.push(data.value);
            });

            // Büyükten küçüğe sırala
            nums.sort((a, b) => b - a);

            teamNumbers.set(teamId, nums);

            // Kartı güncelle
            count.textContent = `Toplam: ${nums.length}`;
            list.innerHTML = "";
            if (nums.length === 0) {
              const li = document.createElement("li");
              li.textContent = "Henüz sayı yok";
              list.appendChild(li);
            } else {
              for (const v of nums) {
                const li = document.createElement("li");
                li.textContent = String(v);
                list.appendChild(li);
              }
            }
          });

          numbersUnsubs.set(teamId, unsub);
        }
      }
    }
  </script>

</body>
</html>
