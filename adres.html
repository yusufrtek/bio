<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firebase Demo: Username + Takıma Katıl</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 1000px; margin: 24px auto; padding: 0 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    input, select, button { padding: 10px; font-size: 14px; }
    button { cursor: pointer; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-top: 14px; }
    .muted { color: #666; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
    ul { margin: 8px 0 0; padding-left: 18px; }
    .pill { display:inline-block; padding: 3px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; }
  </style>
</head>
<body>

  <h1>Firebase Demo: Username + Takım Kur / Katıl</h1>
  <p class="muted">Aynı sayfayı başka cihazda aç; anlık güncellenir.</p>

  <div class="card">
    <h2>0) Kullanıcı adı</h2>
    <div class="row">
      <input id="username" placeholder="Username (örn: Yusuf)" />
      <button id="saveUsernameBtn">Kaydet</button>
      <span class="pill" id="meInfo">Henüz ayarlanmadı</span>
    </div>
    <p class="muted">Username tarayıcında (localStorage) saklanır.</p>
  </div>

  <div class="card">
    <h2>1) Takım oluştur</h2>
    <div class="row">
      <input id="teamName" placeholder="Takım adı (örn: Mavi)" />
      <button id="createTeamBtn">Takım Oluştur</button>
    </div>
  </div>

  <div class="card">
    <h2>2) Takıma katıl</h2>
    <div class="row">
      <select id="teamSelect"></select>
      <button id="joinTeamBtn">Seçili Takıma Katıl</button>
      <span class="pill" id="teamInfo">Takım yok</span>
    </div>
    <p class="muted">Katılınca takımın altına <b>members</b> koleksiyonuna yazılır.</p>
  </div>

  <div class="card">
    <h2>3) Takımlar (üyeler + sayılar)</h2>
    <div id="teamsContainer" class="grid"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      setDoc,
      getDoc,
      onSnapshot,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCbBh9ulc4_tds31MsDbiSgaHPUU3l0Qx4",
      authDomain: "maps-52b00.firebaseapp.com",
      projectId: "maps-52b00",
      storageBucket: "maps-52b00.firebasestorage.app",
      messagingSenderId: "485125559932",
      appId: "1:485125559932:web:7d304f3f2cda4ef4c21bf9",
      measurementId: "G-YHHXDYCCG7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- UI ----------
    const usernameEl = document.getElementById("username");
    const saveUsernameBtn = document.getElementById("saveUsernameBtn");
    const meInfo = document.getElementById("meInfo");

    const teamNameEl = document.getElementById("teamName");
    const createTeamBtn = document.getElementById("createTeamBtn");

    const teamSelect = document.getElementById("teamSelect");
    const joinTeamBtn = document.getElementById("joinTeamBtn");
    const teamInfo = document.getElementById("teamInfo");

    const teamsContainer = document.getElementById("teamsContainer");

    // ---------- Local identity (demo) ----------
    // Gerçek projede Firebase Auth kullanacağız. Şimdilik basit:
    const myId = getOrCreateLocalId(); // benzersiz kullanıcı id
    let myName = localStorage.getItem("demo_username") || "";
    let myTeamId = localStorage.getItem("demo_teamId") || "";

    function getOrCreateLocalId() {
      let id = localStorage.getItem("demo_userId");
      if (!id) {
        id = "u_" + crypto.randomUUID();
        localStorage.setItem("demo_userId", id);
      }
      return id;
    }

    function refreshMeUI() {
      usernameEl.value = myName;
      meInfo.textContent = myName ? `Sen: ${myName}` : "Henüz ayarlanmadı";
      teamInfo.textContent = myTeamId ? `Takım: ${myTeamId}` : "Takım yok";
    }
    refreshMeUI();

    saveUsernameBtn.addEventListener("click", () => {
      const val = usernameEl.value.trim();
      if (!val) return alert("Username boş olamaz.");
      myName = val;
      localStorage.setItem("demo_username", myName);
      refreshMeUI();
    });

    // ---------- Teams state ----------
    const teamsMap = new Map(); // teamId -> {name}
    const membersByTeam = new Map(); // teamId -> [{id,name}]
    const numbersByTeam = new Map(); // teamId -> [numbers]

    // 1) Team create
    createTeamBtn.addEventListener("click", async () => {
      const name = teamNameEl.value.trim();
      if (!name) return alert("Takım adı yaz.");

      // basit duplicate kontrol
      for (const [, t] of teamsMap) {
        if ((t.name || "").toLowerCase() === name.toLowerCase()) {
          return alert("Bu isimde takım zaten var.");
        }
      }

      await addDoc(collection(db, "teams"), {
        name,
        createdAt: serverTimestamp()
      });

      teamNameEl.value = "";
    });

    // 2) Join team
    joinTeamBtn.addEventListener("click", async () => {
      if (!myName) return alert("Önce username kaydet.");
      const teamId = teamSelect.value;
      if (!teamId) return alert("Takım yok / seçilmedi.");

      // teams/{teamId}/members/{myId}
      await setDoc(doc(db, "teams", teamId, "members", myId), {
        id: myId,
        name: myName,
        joinedAt: serverTimestamp()
      }, { merge: true });

      myTeamId = teamId;
      localStorage.setItem("demo_teamId", myTeamId);
      refreshMeUI();
    });

    // ---------- Real-time: teams ----------
    onSnapshot(collection(db, "teams"), (snap) => {
      teamsMap.clear();
      snap.forEach((d) => teamsMap.set(d.id, d.data()));

      // select doldur
      teamSelect.innerHTML = "";
      if (teamsMap.size === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Önce takım oluştur";
        teamSelect.appendChild(opt);
      } else {
        for (const [id, t] of teamsMap) {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = t.name || id;
          if (id === myTeamId) opt.selected = true;
          teamSelect.appendChild(opt);
        }
      }

      renderTeams();
      ensureSubs();
    });

    // ---------- Subscriptions per team ----------
    const memberUnsubs = new Map();
    const numberUnsubs = new Map();

    function ensureSubs() {
      // kaldırılması gerekenleri kaldır
      for (const [teamId, unsub] of memberUnsubs) {
        if (!teamsMap.has(teamId)) { unsub(); memberUnsubs.delete(teamId); membersByTeam.delete(teamId); }
      }
      for (const [teamId, unsub] of numberUnsubs) {
        if (!teamsMap.has(teamId)) { unsub(); numberUnsubs.delete(teamId); numbersByTeam.delete(teamId); }
      }

      // yeni takımlara subscribe
      for (const [teamId] of teamsMap) {
        if (!memberUnsubs.has(teamId)) {
          const qMembers = query(collection(db, "teams", teamId, "members"), orderBy("joinedAt", "asc"));
          memberUnsubs.set(teamId, onSnapshot(qMembers, (snap) => {
            const arr = [];
            snap.forEach((d) => arr.push(d.data()));
            membersByTeam.set(teamId, arr);
            renderTeams();
          }));
        }

        if (!numberUnsubs.has(teamId)) {
          const qNums = query(collection(db, "teams", teamId, "numbers"), orderBy("createdAt", "desc"));
          numberUnsubs.set(teamId, onSnapshot(qNums, (snap) => {
            const nums = [];
            snap.forEach((d) => {
              const data = d.data();
              if (typeof data.value === "number") nums.push(data.value);
            });
            nums.sort((a, b) => b - a);
            numbersByTeam.set(teamId, nums);
            renderTeams();
          }));
        }
      }
    }

    // ---------- Render ----------
    function renderTeams() {
      teamsContainer.innerHTML = "";

      for (const [teamId, t] of teamsMap) {
        const card = document.createElement("div");
        card.className = "card";

        const h = document.createElement("h3");
        h.textContent = `${t.name || "Takım"} (${teamId})`;
        card.appendChild(h);

        // members
        const members = membersByTeam.get(teamId) || [];
        const mTitle = document.createElement("div");
        mTitle.className = "muted";
        mTitle.textContent = `Üyeler (${members.length})`;
        card.appendChild(mTitle);

        const mList = document.createElement("ul");
        if (members.length === 0) {
          const li = document.createElement("li");
          li.textContent = "Henüz üye yok";
          mList.appendChild(li);
        } else {
          for (const m of members) {
            const li = document.createElement("li");
            li.textContent = `${m.name}${m.id === myId ? " (sen)" : ""}`;
            mList.appendChild(li);
          }
        }
        card.appendChild(mList);

        // numbers
        const nums = numbersByTeam.get(teamId) || [];
        const nTitle = document.createElement("div");
        nTitle.className = "muted";
        nTitle.style.marginTop = "10px";
        nTitle.textContent = `Sayılar (büyükten küçüğe) — toplam ${nums.length}`;
        card.appendChild(nTitle);

        const nList = document.createElement("ul");
        if (nums.length === 0) {
          const li = document.createElement("li");
          li.textContent = "Henüz sayı yok";
          nList.appendChild(li);
        } else {
          for (const v of nums) {
            const li = document.createElement("li");
            li.textContent = String(v);
            nList.appendChild(li);
          }
        }
        card.appendChild(nList);

        teamsContainer.appendChild(card);
      }
    }
  </script>
</body>
</html>
