<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test Shop (GitHub Pages + Render)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 860px; margin: 24px auto; padding: 0 14px; }
    .row { display: flex; gap: 14px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; flex: 1; min-width: 240px; }
    button { padding: 10px 12px; border: 0; border-radius: 10px; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    input { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
    .muted { color: #666; font-size: 12px; }
    pre { background: #f6f6f6; padding: 12px; border-radius: 10px; overflow:auto; }
    .right { text-align: right; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; background:#eee; font-size:12px; }
  </style>
</head>
<body>
  <h2>üß™ Test Shop</h2>
  <p class="muted">GitHub Pages (HTML) ‚Üí Render (Node.js API) test sayfasƒ±</p>

  <div class="card">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div>
        <div><strong>API Durumu:</strong> <span id="apiStatus" class="badge">Bilinmiyor</span></div>
        <div class="muted" id="apiUrlText"></div>
      </div>
      <button id="btnPing">API Test Et</button>
    </div>
  </div>

  <h3>√úr√ºnler</h3>
  <div class="row" id="products"></div>

  <h3>Sepet</h3>
  <div class="card">
    <div id="cartEmpty" class="muted">Sepet bo≈ü.</div>
    <div id="cartList"></div>
    <hr />
    <div class="row" style="align-items:center;">
      <div style="flex:2">
        <label class="muted">Order ID (test i√ßin):</label>
        <input id="orderId" placeholder="√ñrn: TEST123" />
      </div>
      <div class="right" style="flex:1">
        <div class="muted">Toplam</div>
        <div style="font-size:20px;"><strong id="total">0 ‚Ç∫</strong></div>
      </div>
    </div>
    <div style="margin-top:12px;" class="row">
      <button id="btnClear">Sepeti Temizle</button>
      <button id="btnPay" style="flex:1;">√ñdemeyi Ba≈ülat</button>
    </div>
    <p class="muted" style="margin-top:10px;">
      Not: ≈ûu an backend‚Äôin <code>/start-payment</code> endpoint‚Äôi sahte link d√∂nd√ºr√ºyor.
      Ger√ßek √∂deme entegrasyonunu sonra ekleyeceƒüiz.
    </p>
  </div>

  <h3>Log</h3>
  <pre id="log"></pre>

<script>
  // ‚úÖ BURAYA KENDƒ∞ RENDER URL'ƒ∞Nƒ∞ YAZ
  const API_BASE = "https://bio-1-mq9x.onrender.com/";

  const PRODUCTS = [
    { id: "urun1", name: "Test √úr√ºn 1", price: 49 },
    { id: "urun2", name: "Test √úr√ºn 2", price: 79 },
    { id: "urun3", name: "Test √úr√ºn 3", price: 129 },
  ];

  const el = (id) => document.getElementById(id);
  const logBox = el("log");

  function log(...args) {
    const line = args.map(a => typeof a === "string" ? a : JSON.stringify(a, null, 2)).join(" ");
    logBox.textContent = (line + "\n") + logBox.textContent;
  }

  // --- Cart (localStorage) ---
  const CART_KEY = "test_cart_v1";

  function getCart() {
    try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
    catch { return []; }
  }

  function setCart(items) {
    localStorage.setItem(CART_KEY, JSON.stringify(items));
    renderCart();
  }

  function addToCart(productId) {
    const cart = getCart();
    const found = cart.find(x => x.productId === productId);
    if (found) found.qty += 1;
    else cart.push({ productId, qty: 1 });
    setCart(cart);
  }

  function decCart(productId) {
    const cart = getCart();
    const found = cart.find(x => x.productId === productId);
    if (!found) return;
    found.qty -= 1;
    const next = cart.filter(x => x.qty > 0);
    setCart(next);
  }

  function clearCart() { setCart([]); }

  function cartTotal() {
    const cart = getCart();
    let sum = 0;
    for (const item of cart) {
      const p = PRODUCTS.find(p => p.id === item.productId);
      if (p) sum += p.price * item.qty;
    }
    return sum;
  }

  // --- UI render ---
  function renderProducts() {
    const wrap = el("products");
    wrap.innerHTML = "";
    for (const p of PRODUCTS) {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div>
            <div><strong>${p.name}</strong></div>
            <div class="muted">${p.price} ‚Ç∫</div>
          </div>
          <button data-add="${p.id}">Sepete Ekle</button>
        </div>
      `;
      wrap.appendChild(div);
    }
    wrap.querySelectorAll("button[data-add]").forEach(btn => {
      btn.addEventListener("click", () => addToCart(btn.dataset.add));
    });
  }

  function renderCart() {
    const cart = getCart();
    el("total").textContent = cartTotal() + " ‚Ç∫";

    el("cartEmpty").style.display = cart.length ? "none" : "block";
    const list = el("cartList");
    list.innerHTML = "";

    for (const item of cart) {
      const p = PRODUCTS.find(p => p.id === item.productId);
      if (!p) continue;

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      row.style.alignItems = "center";
      row.style.gap = "10px";
      row.style.padding = "8px 0";
      row.innerHTML = `
        <div>
          <div><strong>${p.name}</strong></div>
          <div class="muted">${p.price} ‚Ç∫ √ó ${item.qty}</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button data-dec="${p.id}">-</button>
          <span><strong>${item.qty}</strong></span>
          <button data-add="${p.id}">+</button>
        </div>
      `;
      list.appendChild(row);
    }

    list.querySelectorAll("button[data-add]").forEach(btn => {
      btn.addEventListener("click", () => addToCart(btn.dataset.add));
    });
    list.querySelectorAll("button[data-dec]").forEach(btn => {
      btn.addEventListener("click", () => decCart(btn.dataset.dec));
    });
  }

  // --- API calls ---
  async function pingApi() {
    el("apiStatus").textContent = "Kontrol ediliyor...";
    try {
      const r = await fetch(`${API_BASE}/`, { method: "GET" });
      const data = await r.json();
      el("apiStatus").textContent = "√áalƒ±≈üƒ±yor ‚úÖ";
      log("PING OK:", data);
    } catch (e) {
      el("apiStatus").textContent = "Hata ‚ùå";
      log("PING ERROR:", String(e));
      alert("API'ye baƒülanamadƒ±. Render URL doƒüru mu? (https olmalƒ±)");
    }
  }

  async function startPayment() {
    const cart = getCart();
    if (!cart.length) return alert("Sepet bo≈ü.");

    const orderId = el("orderId").value.trim() || ("TEST_" + Date.now());

    const btn = el("btnPay");
    btn.disabled = true;
    btn.textContent = "G√∂nderiliyor...";

    try {
      const r = await fetch(`${API_BASE}/start-payment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId })
      });

      const data = await r.json();
      log("START PAYMENT:", { orderId, response: data });

      if (!r.ok) {
        alert(data?.error || "Hata olu≈ütu");
        return;
      }

      if (!data.paymentUrl) {
        alert("paymentUrl gelmedi. Backend yanƒ±tƒ±nƒ± kontrol et.");
        return;
      }

      // Test: √∂nce g√∂ster
      if (confirm("√ñdeme sayfasƒ±na y√∂nlendirilsin mi?\n\n" + data.paymentUrl)) {
        window.location.href = data.paymentUrl;
      }
    } catch (e) {
      log("START PAYMENT ERROR:", String(e));
      alert("ƒ∞stek atƒ±lamadƒ±. CORS/URL kontrol et.");
    } finally {
      btn.disabled = false;
      btn.textContent = "√ñdemeyi Ba≈ülat";
    }
  }

  // --- init ---
  el("apiUrlText").textContent = API_BASE;
  el("btnPing").addEventListener("click", pingApi);
  el("btnPay").addEventListener("click", startPayment);
  el("btnClear").addEventListener("click", clearCart);

  renderProducts();
  renderCart();
  pingApi();
</script>
</body>
</html>
