<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Shop Test (Render + Firebase)</title>
  <style>
    :root{ --b:#111; --g:#666; --bd:#e6e6e6; --bg:#fafafa; --card:#fff; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,Segoe UI,Arial; background:var(--bg); color:var(--b); }
    .wrap{ max-width:980px; margin:0 auto; padding:18px; }
    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    h1{ font-size:18px; margin:0; }
    .pill{ font-size:12px; padding:6px 10px; border:1px solid var(--bd); border-radius:999px; background:#fff; }
    .grid{ display:grid; grid-template-columns: 1.3fr .7fr; gap:14px; margin-top:14px; }
    @media (max-width: 860px){ .grid{ grid-template-columns:1fr; } }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:14px; padding:14px; }
    .muted{ color:var(--g); font-size:12px; }
    .row{ display:flex; gap:10px; align-items:center; }
    .row > *{ flex:1; }
    input{ width:100%; padding:10px 12px; border:1px solid #d8d8d8; border-radius:12px; outline:none; }
    input:focus{ border-color:#bdbdbd; }
    button{
      border:0; border-radius:12px; padding:10px 12px; cursor:pointer;
      background:#111; color:#fff; font-weight:600;
    }
    button.secondary{ background:#fff; color:#111; border:1px solid var(--bd); }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .products{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    @media (max-width: 860px){ .products{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px){ .products{ grid-template-columns: 1fr; } }
    .p{
      border:1px solid var(--bd); border-radius:14px; padding:12px; background:#fff;
      display:flex; flex-direction:column; gap:10px;
    }
    .p strong{ font-size:14px; }
    .p .price{ font-weight:700; }
    .cartItem{ display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-top:1px dashed #e8e8e8; gap:10px; }
    .cartItem:first-child{ border-top:0; }
    .qty{ display:flex; gap:8px; align-items:center; }
    .qty button{ padding:8px 10px; border-radius:10px; }
    .qty span{ min-width:22px; text-align:center; font-weight:700; }
    pre{ background:#0b0b0b; color:#d7ffd7; padding:12px; border-radius:14px; overflow:auto; font-size:12px; }
    .total{ display:flex; justify-content:space-between; align-items:center; margin-top:10px; padding-top:10px; border-top:1px solid var(--bd); }
    .ok{ color:#0a7b2a; }
    .bad{ color:#b00020; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üß™ Mini Shop Test</h1>
      <div class="pill">API: <span id="apiStatus">Kontrol ediliyor‚Ä¶</span></div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="row" style="align-items:flex-end;">
          <div>
            <div class="muted">Render API Base</div>
            <input id="apiBase" value="https://bio-1-mq9x.onrender.com" />
            <div class="muted">Sonda ‚Äú/‚Äù olmasƒ±n.</div>
          </div>
          <div style="max-width:180px;">
            <button class="secondary" id="btnPing">Ping</button>
          </div>
        </div>

        <h3 style="margin:14px 0 8px;">√úr√ºnler</h3>
        <div class="products" id="products"></div>

        <p class="muted" style="margin-top:10px;">
          Not: √úr√ºnler ≈üu an front-end‚Äôde sabit. Ger√ßekte fiyat/√ºr√ºn listesini backend‚Äôden aldƒ±racaƒüƒ±z.
        </p>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h3 style="margin:0 0 8px;">Sepet</h3>
        <div id="cart"></div>

        <div class="total">
          <div class="muted">Toplam</div>
          <div style="font-size:18px; font-weight:800;" id="total">0 ‚Ç∫</div>
        </div>

        <div style="margin-top:12px;">
          <div class="muted">M√º≈üteri</div>
          <div class="row" style="margin-top:8px;">
            <input id="name" placeholder="Ad Soyad" value="Yusuf" />
            <input id="email" placeholder="E-posta" value="test@mail.com" />
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="muted">Order ID (otomatik dolar)</div>
          <input id="orderId" placeholder="√ñnce sipari≈ü olu≈ütur" />
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="secondary" id="btnClear">Sepeti Temizle</button>
          <button id="btnCreate">Sipari≈ü Olu≈ütur</button>
        </div>

        <button style="margin-top:10px;" id="btnPay">√ñdemeyi Ba≈ülat</button>

        <p class="muted" style="margin-top:10px;">
          ≈ûimdilik √∂deme linki <code>example.com</code> d√∂ner. Ger√ßek saƒülayƒ±cƒ±yƒ± sonra baƒülarƒ±z.
        </p>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="row" style="align-items:center;">
        <div>
          <strong>Log</strong>
          <div class="muted">Ham cevaplarƒ± burada g√∂r√ºrs√ºn.</div>
        </div>
        <div style="max-width:180px;">
          <button class="secondary" id="btnLogClear">Log Temizle</button>
        </div>
      </div>
      <pre id="log">Hazƒ±r.</pre>
    </div>
  </div>

<script>
  // ====== Ayarlar ======
  const CART_KEY = "mini_shop_cart_v1";
  const PRODUCTS = [
    { id:"urun1", name:"Test √úr√ºn 1", price:49 },
    { id:"urun2", name:"Test √úr√ºn 2", price:79 },
    { id:"urun3", name:"Test √úr√ºn 3", price:129 },
    { id:"urun4", name:"Test √úr√ºn 4", price:199 },
    { id:"urun5", name:"Test √úr√ºn 5", price:29 },
    { id:"urun6", name:"Test √úr√ºn 6", price:99 },
  ];

  const $ = (id) => document.getElementById(id);
  const logEl = $("log");

  function apiBase(){
    return $("apiBase").value.trim().replace(/\/$/, "");
  }

  function log(title, data){
    const t = typeof data === "string" ? data : JSON.stringify(data, null, 2);
    logEl.textContent = `${title}\n${t}\n\n` + logEl.textContent;
  }

  // ====== Sepet ======
  function getCart(){
    try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
    catch { return []; }
  }
  function setCart(cart){
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    renderCart();
  }
  function add(pid){
    const c = getCart();
    const f = c.find(x => x.productId === pid);
    if (f) f.qty += 1;
    else c.push({ productId: pid, qty: 1 });
    setCart(c);
  }
  function dec(pid){
    const c = getCart();
    const f = c.find(x => x.productId === pid);
    if (!f) return;
    f.qty -= 1;
    setCart(c.filter(x => x.qty > 0));
  }
  function clearCart(){ setCart([]); }
  function total(){
    let sum = 0;
    for (const it of getCart()){
      const p = PRODUCTS.find(p => p.id === it.productId);
      if (p) sum += p.price * it.qty;
    }
    return sum;
  }

  // ====== UI ======
  function renderProducts(){
    const wrap = $("products");
    wrap.innerHTML = "";
    for (const p of PRODUCTS){
      const d = document.createElement("div");
      d.className = "p";
      d.innerHTML = `
        <div>
          <strong>${p.name}</strong>
          <div class="muted">ID: ${p.id}</div>
        </div>
        <div class="row" style="align-items:center;">
          <div class="price">${p.price} ‚Ç∫</div>
          <button data-add="${p.id}">Sepete</button>
        </div>
      `;
      wrap.appendChild(d);
    }
    wrap.querySelectorAll("button[data-add]").forEach(b=>{
      b.addEventListener("click", ()=> add(b.dataset.add));
    });
  }

  function renderCart(){
    const wrap = $("cart");
    const c = getCart();
    $("total").textContent = total() + " ‚Ç∫";
    wrap.innerHTML = "";

    if (!c.length){
      wrap.innerHTML = `<div class="muted">Sepet bo≈ü.</div>`;
      return;
    }

    for (const it of c){
      const p = PRODUCTS.find(p => p.id === it.productId);
      if (!p) continue;
      const row = document.createElement("div");
      row.className = "cartItem";
      row.innerHTML = `
        <div>
          <div><strong>${p.name}</strong></div>
          <div class="muted">${p.price} ‚Ç∫ √ó ${it.qty}</div>
        </div>
        <div class="qty">
          <button class="secondary" data-dec="${p.id}">-</button>
          <span>${it.qty}</span>
          <button data-add="${p.id}">+</button>
        </div>
      `;
      wrap.appendChild(row);
    }

    wrap.querySelectorAll("button[data-add]").forEach(b=>{
      b.addEventListener("click", ()=> add(b.dataset.add));
    });
    wrap.querySelectorAll("button[data-dec]").forEach(b=>{
      b.addEventListener("click", ()=> dec(b.dataset.dec));
    });
  }

  // ====== API ======
  async function ping(){
    $("apiStatus").textContent = "‚Ä¶";
    try{
      const r = await fetch(apiBase() + "/");
      const raw = await r.text();
      log("PING:", raw);
      // Basit durum
      $("apiStatus").textContent = r.ok ? "√áalƒ±≈üƒ±yor ‚úÖ" : "Hata ‚ùå";
      $("apiStatus").className = r.ok ? "ok" : "bad";
    }catch(e){
      $("apiStatus").textContent = "Hata ‚ùå";
      $("apiStatus").className = "bad";
      log("PING ERROR:", String(e));
      alert("Ping hata. Render URL doƒüru mu?");
    }
  }

  async function createOrder(){
    const items = getCart();
    if (!items.length) return alert("Sepet bo≈ü.");

    const customer = {
      name: $("name").value.trim(),
      email: $("email").value.trim()
    };

    $("btnCreate").disabled = true;
    $("btnCreate").textContent = "G√∂nderiliyor‚Ä¶";

    try{
      const r = await fetch(apiBase() + "/create-order", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ items, customer })
      });
      const raw = await r.text();
      log("/create-order:", raw);

      if (!r.ok) return alert("create-order hata: " + raw);

      const data = JSON.parse(raw);
      $("orderId").value = data.orderId || "";
      alert("Sipari≈ü olu≈üturuldu ‚úÖ\nOrderId: " + (data.orderId || ""));
    }catch(e){
      log("CREATE ORDER ERROR:", String(e));
      alert("create-order istek hatasƒ±.");
    }finally{
      $("btnCreate").disabled = false;
      $("btnCreate").textContent = "Sipari≈ü Olu≈ütur";
    }
  }

  async function startPayment(){
    const orderId = $("orderId").value.trim();
    if (!orderId) return alert("√ñnce sipari≈ü olu≈ütur (orderId bo≈ü).");

    $("btnPay").disabled = true;
    $("btnPay").textContent = "Ba≈ülatƒ±lƒ±yor‚Ä¶";

    try{
      const r = await fetch(apiBase() + "/start-payment", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ orderId })
      });
      const raw = await r.text();
      log("/start-payment:", raw);

      if (!r.ok) return alert("start-payment hata: " + raw);

      const data = JSON.parse(raw);
      if (data.paymentUrl && confirm("√ñdeme linkine gitsin mi?\n\n" + data.paymentUrl)){
        window.location.href = data.paymentUrl;
      }
    }catch(e){
      log("START PAYMENT ERROR:", String(e));
      alert("start-payment istek hatasƒ±.");
    }finally{
      $("btnPay").disabled = false;
      $("btnPay").textContent = "√ñdemeyi Ba≈ülat";
    }
  }

  // ====== Events ======
  $("btnPing").addEventListener("click", ping);
  $("btnClear").addEventListener("click", clearCart);
  $("btnCreate").addEventListener("click", createOrder);
  $("btnPay").addEventListener("click", startPayment);
  $("btnLogClear").addEventListener("click", ()=> logEl.textContent = "Temizlendi.");

  // init
  renderProducts();
  renderCart();
  ping();
</script>
</body>
</html>
