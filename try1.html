<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Firebase GiriÅŸ / KayÄ±t (Google + Email)</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: #0b0f17; color: #e7eaf0;
      display: grid; place-items: center; min-height: 100vh;
    }
    .wrap { width: min(980px, 92vw); display: grid; gap: 16px; }
    .card {
      background: #111827; border: 1px solid #1f2a44; border-radius: 14px;
      padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    h1 { margin: 0 0 8px; font-size: 20px; }
    h2 { margin: 0 0 12px; font-size: 16px; opacity: .95; }
    label { font-size: 12px; opacity: .85; display: block; margin: 10px 0 6px; }
    input {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #263457; background: #0b1222; color: #e7eaf0;
      outline: none;
    }
    input:focus { border-color: #3b82f6; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btns { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
    button {
      border: 1px solid #2a3b64; background: #0b1222; color: #e7eaf0;
      padding: 10px 12px; border-radius: 10px; cursor: pointer;
    }
    button.primary { background: #1d4ed8; border-color: #1d4ed8; }
    button.danger { background: #991b1b; border-color: #991b1b; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .hint { font-size: 12px; opacity: .75; margin-top: 8px; line-height: 1.4; }
    .msg {
      margin-top: 12px; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #263457; background: #0b1222; font-size: 13px;
      white-space: pre-wrap;
    }
    .ok { border-color: #14532d; background: #052012; }
    .err { border-color: #7f1d1d; background: #1a0606; }
    .warn { border-color: #7c5e10; background: #1a1405; }
    .topbar { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .pill { font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid #263457; background: #0b1222; opacity: .9; }
    .mini { font-size: 12px; opacity: .75; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <h1>Firebase Auth Demo (Google + Email/Åifre)</h1>
        <div class="pill" id="statusPill">Durum: â€”</div>
      </div>
      <div class="mini">
        Not: Firebase Consoleâ€™da <b>Authentication â†’ Sign-in method</b> kÄ±smÄ±ndan <b>Email/Password</b> ve <b>Google</b> providerâ€™Ä±nÄ± aÃ§malÄ±sÄ±n.
        Google iÃ§in ayrÄ±ca <b>Authorized domains</b> kÄ±smÄ±nda test ettiÄŸin domain (Ã¶rn. <code>localhost</code>) olmalÄ±.
      </div>
    </div>

    <div class="grid">
      <!-- SIGN UP -->
      <div class="card">
        <h2>Ãœye Ol (Email + Åifre)</h2>

        <label>KullanÄ±cÄ± adÄ±</label>
        <input id="su_username" placeholder="Ã¶rn: yusuf_06" autocomplete="nickname" />

        <label>DoÄŸum tarihi</label>
        <input id="su_birth" type="date" />

        <label>E-posta</label>
        <input id="su_email" type="email" placeholder="ornek@mail.com" autocomplete="email" />

        <label>Åifre</label>
        <input id="su_pass" type="password" placeholder="En az 6 karakter" autocomplete="new-password" />

        <div class="btns">
          <button class="primary" id="btnSignUp">Ãœye Ol</button>
          <button id="btnSendVerify" disabled>DoÄŸrulama Maili GÃ¶nder</button>
        </div>

        <div class="hint">
          â€¢ Ãœyelik sonrasÄ± kullanÄ±cÄ± adÄ± + doÄŸum tarihi <b>Realtime Database</b> iÃ§ine kaydedilir.<br/>
          â€¢ Ä°stersen bunu Firestoreâ€™a Ã§evirebilirim.
        </div>

        <div class="msg" id="su_msg">â€”</div>
      </div>

      <!-- LOGIN -->
      <div class="card">
        <h2>GiriÅŸ Yap</h2>

        <label>E-posta</label>
        <input id="li_email" type="email" placeholder="ornek@mail.com" autocomplete="email" />

        <label>Åifre</label>
        <input id="li_pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />

        <div class="btns">
          <button class="primary" id="btnLogin">GiriÅŸ Yap</button>
          <button id="btnReset">Åifre SÄ±fÄ±rlama Maili</button>
          <button class="danger" id="btnLogout" disabled>Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>

        <hr style="border:0;border-top:1px solid #1f2a44;margin:14px 0;"/>

        <h2>Google ile GiriÅŸ</h2>
        <div class="btns">
          <button class="primary" id="btnGoogle">Google ile GiriÅŸ Yap</button>
        </div>

        <div class="msg" id="li_msg">â€”</div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="card">
      <h2>Oturum Bilgisi</h2>
      <div class="msg" id="me_msg">â€”</div>
      <div class="hint">
        Realtime Database yolu: <code>/users/{uid}</code> (username, birthdate, email, provider, createdAt)
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK (CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      sendEmailVerification,
      sendPasswordResetEmail,
      updateProfile,
      reload,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
      getDatabase,
      ref,
      set,
      get
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // âœ… SENÄ°N CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyCbBh9ulc4_tds31MsDbiSgaHPUU3l0Qx4",
      authDomain: "maps-52b00.firebaseapp.com",
      databaseURL: "https://maps-52b00-default-rtdb.europe-west1.firebaseapp.com",
      projectId: "maps-52b00",
      storageBucket: "maps-52b00.firebasestorage.app",
      messagingSenderId: "485125559932",
      appId: "1:485125559932:web:7d304f3f2cda4ef4c21bf9",
      measurementId: "G-YHHXDYCCG7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    // --- UI helpers ---
    const $ = (id) => document.getElementById(id);
    const statusPill = $("statusPill");

    function setMsg(el, text, type = "warn") {
      el.classList.remove("ok","err","warn");
      el.classList.add(type);
      el.textContent = text;
    }

    function prettyErr(e) {
      const code = e?.code || "";
      // KullanÄ±cÄ± dostu birkaÃ§ yaygÄ±n hata
      const map = {
        "auth/email-already-in-use": "Bu e-posta zaten kayÄ±tlÄ±. GiriÅŸ yapmayÄ± deneyin.",
        "auth/invalid-email": "E-posta formatÄ± hatalÄ±.",
        "auth/weak-password": "Åifre zayÄ±f. En az 6 karakter olmalÄ±.",
        "auth/wrong-password": "Åifre yanlÄ±ÅŸ.",
        "auth/user-not-found": "Bu e-posta ile kullanÄ±cÄ± bulunamadÄ±.",
        "auth/popup-closed-by-user": "Google giriÅŸ penceresi kapatÄ±ldÄ±.",
        "auth/operation-not-allowed": "Bu giriÅŸ yÃ¶ntemi Firebase Consoleâ€™da kapalÄ±. (Email/Password veya Google)",
        "auth/network-request-failed": "AÄŸ hatasÄ±. Ä°nternet baÄŸlantÄ±nÄ± kontrol et."
      };
      return map[code] ? `${map[code]} (${code})` : `${e?.message || e} ${code ? "(" + code + ")" : ""}`;
    }

    function normalizeUsername(u) {
      return (u || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "_")
        .replace(/[^a-z0-9_\.]/g, "");
    }

    function validateBirthdate(iso) {
      // Basit doÄŸrulama: boÅŸ deÄŸil ve gelecekte deÄŸil
      if (!iso) return "DoÄŸum tarihi zorunlu.";
      const d = new Date(iso + "T00:00:00");
      if (Number.isNaN(d.getTime())) return "DoÄŸum tarihi geÃ§ersiz.";
      const now = new Date();
      if (d > now) return "DoÄŸum tarihi gelecekte olamaz.";
      return null;
    }

    async function upsertUserProfile(user, extra = {}) {
      const userRef = ref(db, `users/${user.uid}`);
      const snapshot = await get(userRef).catch(() => null);

      const base = {
        uid: user.uid,
        email: user.email || null,
        displayName: user.displayName || null,
        photoURL: user.photoURL || null,
        provider: (user.providerData?.[0]?.providerId) || null,
        updatedAt: Date.now()
      };

      // Ä°lk kez set ediyorsak createdAt da ekleyelim
      const payload = snapshot?.exists()
        ? { ...(snapshot.val() || {}), ...base, ...extra }
        : { ...base, ...extra, createdAt: Date.now() };

      await set(userRef, payload);
      return payload;
    }

    // --- Elements ---
    const su_msg = $("su_msg");
    const li_msg = $("li_msg");
    const me_msg = $("me_msg");

    const btnSignUp = $("btnSignUp");
    const btnSendVerify = $("btnSendVerify");
    const btnLogin = $("btnLogin");
    const btnReset = $("btnReset");
    const btnGoogle = $("btnGoogle");
    const btnLogout = $("btnLogout");

    // --- Actions ---
    btnSignUp.onclick = async () => {
      setMsg(su_msg, "â³ Ãœye olunuyor...", "warn");

      const usernameRaw = $("su_username").value;
      const username = normalizeUsername(usernameRaw);
      const birth = $("su_birth").value;
      const email = $("su_email").value.trim();
      const pass = $("su_pass").value;

      if (!username) {
        setMsg(su_msg, "âŒ KullanÄ±cÄ± adÄ± zorunlu. (Sadece harf/rakam/_/.)", "err");
        return;
      }
      if (username.length < 3) {
        setMsg(su_msg, "âŒ KullanÄ±cÄ± adÄ± en az 3 karakter olmalÄ±.", "err");
        return;
      }
      const birthErr = validateBirthdate(birth);
      if (birthErr) {
        setMsg(su_msg, "âŒ " + birthErr, "err");
        return;
      }
      if (!email) {
        setMsg(su_msg, "âŒ E-posta zorunlu.", "err");
        return;
      }
      if (!pass || pass.length < 6) {
        setMsg(su_msg, "âŒ Åifre en az 6 karakter olmalÄ±.", "err");
        return;
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);

        // Auth profiline displayName yazalÄ±m
        await updateProfile(cred.user, { displayName: username });

        // DB'ye kullanÄ±cÄ± profilini kaydet
        await upsertUserProfile(cred.user, {
          username,
          birthdate: birth,
          email,
          provider: "password"
        });

        // DoÄŸrulama maili isteÄŸi (teslimat mail saÄŸlayÄ±cÄ±na gÃ¶re deÄŸiÅŸebilir)
        await sendEmailVerification(cred.user);

        setMsg(
          su_msg,
          "âœ… Ãœyelik tamamlandÄ±.\nğŸ“© DoÄŸrulama maili gÃ¶nderme isteÄŸi yapÄ±ldÄ±.\n" +
          "â¡ï¸ Mail doÄŸrulamasÄ± gelmezse Spam/TanÄ±tÄ±mlar kontrol et ve giriÅŸ yaptÄ±ktan sonra 'DoÄŸrulama Maili GÃ¶nder' butonunu deneyebilirsin.",
          "ok"
        );

        btnSendVerify.disabled = false;
      } catch (e) {
        setMsg(su_msg, "âŒ " + prettyErr(e), "err");
      }
    };

    btnSendVerify.onclick = async () => {
      try {
        if (!auth.currentUser) {
          setMsg(su_msg, "âŒ Ã–nce giriÅŸ yapmalÄ±sÄ±n (oturum yok).", "err");
          return;
        }
        await sendEmailVerification(auth.currentUser);
        setMsg(su_msg, "âœ… DoÄŸrulama maili tekrar gÃ¶nderme isteÄŸi yapÄ±ldÄ±.", "ok");
      } catch (e) {
        setMsg(su_msg, "âŒ " + prettyErr(e), "err");
      }
    };

    btnLogin.onclick = async () => {
      setMsg(li_msg, "â³ GiriÅŸ yapÄ±lÄ±yor...", "warn");

      const email = $("li_email").value.trim();
      const pass = $("li_pass").value;

      if (!email || !pass) {
        setMsg(li_msg, "âŒ E-posta ve ÅŸifre zorunlu.", "err");
        return;
      }

      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);

        // emailVerified cache'li kalabilir; yenile
        await reload(cred.user);

        if (!cred.user.emailVerified) {
          setMsg(
            li_msg,
            "âš ï¸ GiriÅŸ baÅŸarÄ±lÄ± ama e-posta doÄŸrulanmamÄ±ÅŸ.\n" +
            "â¡ï¸ DoÄŸrulama mailini bulup tÄ±kla, sonra tekrar 'DoÄŸrulama Maili GÃ¶nder' veya sayfayÄ± yenile.",
            "warn"
          );
          btnSendVerify.disabled = false;
        } else {
          setMsg(li_msg, "âœ… GiriÅŸ baÅŸarÄ±lÄ±. (E-posta doÄŸrulanmÄ±ÅŸ)", "ok");
        }

        await upsertUserProfile(cred.user, { provider: "password" });

      } catch (e) {
        setMsg(li_msg, "âŒ " + prettyErr(e), "err");
      }
    };

    btnReset.onclick = async () => {
      const email = $("li_email").value.trim();
      if (!email) {
        setMsg(li_msg, "âŒ Åifre sÄ±fÄ±rlama iÃ§in e-posta yazmalÄ±sÄ±n.", "err");
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        setMsg(li_msg, "âœ… Åifre sÄ±fÄ±rlama maili gÃ¶nderme isteÄŸi yapÄ±ldÄ±.", "ok");
      } catch (e) {
        setMsg(li_msg, "âŒ " + prettyErr(e), "err");
      }
    };

    btnGoogle.onclick = async () => {
      setMsg(li_msg, "â³ Google ile giriÅŸ yapÄ±lÄ±yor...", "warn");
      try {
        const cred = await signInWithPopup(auth, googleProvider);

        // Google ile giriÅŸte biz username + birthdate almadÄ±k.
        // Demo iÃ§in: eÄŸer profilde yoksa kullanÄ±cÄ±dan sonra eklettirebilirsin.
        const profile = await upsertUserProfile(cred.user, { provider: "google.com" });

        setMsg(
          li_msg,
          "âœ… Google ile giriÅŸ baÅŸarÄ±lÄ±.\n" +
          (profile?.username ? "â€¢ KullanÄ±cÄ± adÄ±: " + profile.username : "â€¢ Not: Google giriÅŸinde kullanÄ±cÄ± adÄ±/doÄŸum tarihi istemedik (istersen ek ekran yaparÄ±z)."),
          "ok"
        );
      } catch (e) {
        setMsg(li_msg, "âŒ " + prettyErr(e), "err");
      }
    };

    btnLogout.onclick = async () => {
      try {
        await signOut(auth);
        setMsg(li_msg, "âœ… Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±.", "ok");
        setMsg(su_msg, "â€”", "warn");
      } catch (e) {
        setMsg(li_msg, "âŒ " + prettyErr(e), "err");
      }
    };

    // --- Auth state ---
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        statusPill.textContent = "Durum: Ã‡Ä±kÄ±ÅŸ yapÄ±lmÄ±ÅŸ";
        btnLogout.disabled = true;
        btnSendVerify.disabled = true;
        setMsg(me_msg, "Oturum yok.", "warn");
        return;
      }

      btnLogout.disabled = false;
      statusPill.textContent = "Durum: GiriÅŸ yapÄ±ldÄ±";

      try {
        await reload(user);
        const verified = !!user.emailVerified;

        // DB profilini Ã§ekelim
        const userRef = ref(db, `users/${user.uid}`);
        const snap = await get(userRef);
        const prof = snap.exists() ? snap.val() : null;

        const lines = [
          `UID: ${user.uid}`,
          `Email: ${user.email || "-"}`,
          `Email Verified: ${verified}`,
          `DisplayName: ${user.displayName || "-"}`,
          `Provider: ${(user.providerData?.[0]?.providerId) || "-"}`,
          `DB Username: ${prof?.username || "-"}`,
          `DB Birthdate: ${prof?.birthdate || "-"}`,
          `DB CreatedAt: ${prof?.createdAt ? new Date(prof.createdAt).toLocaleString() : "-"}`
        ];

        setMsg(me_msg, lines.join("\n"), "ok");

        // Email/password kullanÄ±yorsa doÄŸrulama butonunu aÃ§
        const providerId = (user.providerData?.[0]?.providerId) || "";
        if (providerId === "password" && !verified) btnSendVerify.disabled = false;

      } catch (e) {
        setMsg(me_msg, "âŒ Profil okunamadÄ±: " + prettyErr(e), "err");
      }
    });

    // Ä°lk mesajlar
    setMsg(su_msg, "Ãœye olmak iÃ§in bilgileri doldur.", "warn");
    setMsg(li_msg, "GiriÅŸ yapmak iÃ§in e-posta/ÅŸifre yaz veya Google ile giriÅŸ yap.", "warn");
    setMsg(me_msg, "Oturum bilgisi burada gÃ¶rÃ¼necek.", "warn");
  </script>
</body>
</html>
