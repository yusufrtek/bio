<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Firebase Telefon (SMS) Doğrulama</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 520px; margin: 40px auto; }
    input, button { width: 100%; padding: 10px; margin: 8px 0; }
    #recaptcha-container { margin: 12px 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .small { font-size: 12px; opacity: .8; }
  </style>
</head>
<body>

  <h2>Telefon Doğrulama (SMS)</h2>

  <label>Telefon (E.164 formatında)</label>
  <input id="phone" placeholder="+905xxxxxxxxx" />

  <div id="recaptcha-container"></div>

  <button id="sendBtn">SMS Kodunu Gönder</button>

  <label>SMS Kodu</label>
  <input id="code" placeholder="123456" />

  <button id="verifyBtn" disabled>Kodu Doğrula</button>

  <p id="result"></p>
  <p class="small">
    Not: Telefon doğrulama için Firebase Console → Authentication → Sign-in method → Phone ENABLED olmalı.
  </p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      RecaptchaVerifier,
      signInWithPhoneNumber
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ✅ SENİN CONFIG (AYNISI)
    const firebaseConfig = {
      apiKey: "AIzaSyCbBh9ulc4_tds31MsDbiSgaHPUU3l0Qx4",
      authDomain: "maps-52b00.firebaseapp.com",
      databaseURL: "https://maps-52b00-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "maps-52b00",
      storageBucket: "maps-52b00.firebasestorage.app",
      messagingSenderId: "485125559932",
      appId: "1:485125559932:web:7d304f3f2cda4ef4c21bf9",
      measurementId: "G-YHHXDYCCG7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const result = document.getElementById("result");
    const sendBtn = document.getElementById("sendBtn");
    const verifyBtn = document.getElementById("verifyBtn");

    // reCAPTCHA (visible)
    const recaptchaVerifier = new RecaptchaVerifier(auth, "recaptcha-container", {
      size: "normal",
      callback: () => {
        // captcha solved
      }
    });

    await recaptchaVerifier.render();

    let confirmationResult = null;

    sendBtn.onclick = async () => {
      try {
        const phone = document.getElementById("phone").value.trim();
        if (!phone.startsWith("+")) {
          result.innerText = "❌ Telefonu +90... formatında yazmalısın (E.164). Örn: +905xxxxxxxxx";
          return;
        }

        result.innerText = "⏳ SMS gönderiliyor...";
        confirmationResult = await signInWithPhoneNumber(auth, phone, recaptchaVerifier);

        result.innerText = "✅ SMS gönderildi. Kodu girip doğrula.";
        verifyBtn.disabled = false;
      } catch (e) {
        console.log(e);
        result.innerText = `❌ ${e.code || ""} - ${e.message || e}`;
        // reCAPTCHA yeniden deneme için
        try { recaptchaVerifier.clear(); } catch {}
        location.reload();
      }
    };

    verifyBtn.onclick = async () => {
      try {
        const code = document.getElementById("code").value.trim();
        if (!confirmationResult) {
          result.innerText = "❌ Önce SMS kodu göndermelisin.";
          return;
        }

        result.innerText = "⏳ Doğrulanıyor...";
        const cred = await confirmationResult.confirm(code);
        result.innerText = `✅ Giriş başarılı! UID: ${cred.user.uid}`;
      } catch (e) {
        console.log(e);
        result.innerText = `❌ ${e.code || ""} - ${e.message || e}`;
      }
    };
  </script>
</body>
</html>
