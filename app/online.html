<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0f">
  <title>Geo Master - Online Photo Contest</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <style>
    :root {
      --bg: #0a0a0f;
      --text: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.6);
      --text-muted: rgba(255, 255, 255, 0.4);
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.12);
      --glass-hover: rgba(255, 255, 255, 0.15);
      --success: #22c55e;
      --error: #ef4444;
      --primary: #6366f1;
      --primary-glow: rgba(99, 102, 241, 0.4);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      overflow: hidden;
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* MAP */
    #map {
      position: fixed;
      inset: 0;
      z-index: 1;
    }

    /* GLASS EFFECT */
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
    }

    /* SCREENS */
    .screen {
      position: fixed;
      inset: 0;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: calc(24px + var(--safe-top)) 24px calc(24px + var(--safe-bottom));
      background: rgba(10, 10, 15, 0.85);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .screen.visible {
      opacity: 1;
      visibility: visible;
    }

    .screen-content {
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* WELCOME SCREEN */
    .welcome-title {
      font-size: clamp(48px, 14vw, 72px);
      font-weight: 700;
      letter-spacing: -3px;
      margin-bottom: 8px;
      opacity: 0;
      transform: translateY(30px);
      animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.2s forwards;
    }

    .welcome-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 56px;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.4s forwards;
    }

    @keyframes fadeUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .stats-row {
      display: flex;
      gap: 48px;
      margin-bottom: 56px;
      opacity: 0;
      animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.6s forwards;
    }

    .stat-box {
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 600;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-top: 6px;
    }

    .main-btn {
      width: 100%;
      padding: 20px 32px;
      background: var(--text);
      color: var(--bg);
      border: none;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s;
      font-family: inherit;
      opacity: 0;
      animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.8s forwards;
    }

    .main-btn:active {
      transform: scale(0.97);
    }

    .main-btn.no-anim {
      opacity: 1;
      animation: none;
    }

    .online-btn {
      width: 100%;
      padding: 20px 32px;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      color: var(--text);
      border: none;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.3s;
      font-family: inherit;
      opacity: 0;
      animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.7s forwards;
      box-shadow: 0 0 30px var(--primary-glow);
      margin-bottom: 12px;
    }

    .online-btn:active {
      transform: scale(0.97);
    }

    .secondary-btn {
      margin-top: 16px;
      padding: 16px 28px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: var(--text);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      opacity: 0;
      animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 1s forwards;
    }

    .secondary-btn:active {
      background: var(--glass-hover);
      transform: scale(0.97);
    }

    .secondary-btn.no-anim {
      opacity: 1;
      animation: none;
    }

    /* BACK BTN */
    .back-btn {
      position: absolute;
      top: calc(24px + var(--safe-top));
      left: 24px;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .back-btn:active {
      background: var(--glass-hover);
      transform: scale(0.95);
    }

    .section-title {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 28px;
    }

    /* LOBBY SCREEN */
    .lobby-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .lobby-code {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 8px;
      margin-bottom: 24px;
      padding: 16px 32px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
    }

    .copy-code-btn {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid var(--glass-border);
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      margin-bottom: 32px;
      transition: all 0.3s;
    }

    .copy-code-btn:active {
      background: var(--glass-hover);
    }

    .players-list {
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 24px;
    }

    .player-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .player-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
    }

    .player-name {
      flex: 1;
      font-size: 15px;
      font-weight: 500;
    }

    .player-host {
      font-size: 11px;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .player-ready {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--success);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .waiting-text {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    /* JOIN SCREEN */
    .join-input {
      width: 100%;
      padding: 18px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      color: var(--text);
      font-size: 24px;
      font-family: inherit;
      text-align: center;
      letter-spacing: 8px;
      text-transform: uppercase;
      outline: none;
      transition: border-color 0.3s;
      margin-bottom: 16px;
    }

    .join-input:focus {
      border-color: var(--primary);
    }

    .join-input::placeholder {
      color: var(--text-muted);
      letter-spacing: 2px;
      font-size: 16px;
    }

    .name-input {
      width: 100%;
      padding: 16px 18px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      color: var(--text);
      font-size: 16px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.3s;
      margin-bottom: 24px;
    }

    .name-input:focus {
      border-color: var(--primary);
    }

    .name-input::placeholder {
      color: var(--text-muted);
    }

    /* ONLINE GAME UI */
    .online-game-ui {
      position: fixed;
      inset: 0;
      z-index: 50;
      display: flex;
      flex-direction: column;
      padding: calc(16px + var(--safe-top)) 16px calc(16px + var(--safe-bottom));
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .online-game-ui.visible {
      opacity: 1;
      visibility: visible;
    }

    .online-game-ui > * {
      pointer-events: auto;
    }

    .online-top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .online-timer-box {
      padding: 14px 24px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      font-size: 24px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      transition: all 0.3s;
    }

    .online-timer-box.warning {
      background: rgba(239, 68, 68, 0.3);
      border-color: rgba(239, 68, 68, 0.5);
      animation: pulse 0.5s ease infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .online-status {
      padding: 14px 24px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .spacer {
      flex: 1;
      pointer-events: none;
    }

    .capture-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      border: 4px solid var(--text);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      box-shadow: 0 0 40px var(--primary-glow);
    }

    .capture-btn:active {
      transform: scale(0.9);
    }

    .capture-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .capture-btn svg {
      width: 32px;
      height: 32px;
      fill: var(--text);
    }

    .capture-hint {
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
      padding: 12px 20px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
    }

    .photo-captured {
      position: fixed;
      bottom: calc(140px + var(--safe-bottom));
      right: 16px;
      width: 100px;
      height: 75px;
      border-radius: 10px;
      border: 2px solid var(--success);
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .photo-captured img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* VOTING SCREEN */
    .voting-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .voting-timer {
      font-size: 48px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 24px;
    }

    .photos-grid {
      width: 100%;
      max-width: 600px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      max-height: 400px;
      overflow-y: auto;
      padding: 4px;
    }

    .photo-card {
      background: var(--glass-bg);
      border: 2px solid var(--glass-border);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
    }

    .photo-card:active {
      transform: scale(0.98);
    }

    .photo-card.selected {
      border-color: var(--primary);
      box-shadow: 0 0 20px var(--primary-glow);
    }

    .photo-card.winner {
      border-color: var(--success);
      box-shadow: 0 0 30px rgba(34, 197, 94, 0.4);
    }

    .photo-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }

    .photo-card-info {
      padding: 12px;
    }

    .photo-card-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .photo-card-votes {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* WINNER SCREEN */
    .winner-crown {
      font-size: 72px;
      margin-bottom: 16px;
    }

    .winner-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .winner-name {
      font-size: 24px;
      color: var(--primary);
      margin-bottom: 24px;
    }

    .winner-photo {
      width: 100%;
      max-width: 300px;
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 24px;
      box-shadow: 0 0 40px var(--primary-glow);
    }

    .winner-photo img {
      width: 100%;
      height: auto;
    }

    .winner-votes {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    /* TOAST */
    .toast {
      position: fixed;
      top: calc(100px + var(--safe-top));
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      padding: 14px 28px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 200;
    }

    .toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: rgba(34, 197, 94, 0.2);
      border-color: rgba(34, 197, 94, 0.4);
    }

    .toast.error {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.4);
    }

    /* LEAFLET OVERRIDES */
    .leaflet-control-zoom {
      display: none !important;
    }

    .leaflet-control-attribution {
      display: none;
    }

    /* SVG ICONS */
    .icon {
      width: 24px;
      height: 24px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* Loading spinner */
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--glass-border);
      border-top-color: var(--text);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 24px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: var(--text-secondary);
    }

    /* Countdown */
    .countdown-number {
      font-size: clamp(140px, 40vw, 220px);
      font-weight: 700;
      opacity: 0;
      transform: scale(0.5);
      animation: countPop 0.9s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes countPop {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }
      60% {
        opacity: 1;
        transform: scale(1.05);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .countdown-text {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 4px;
      margin-top: 20px;
    }

    .icon-btn {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .icon-btn:active {
      background: var(--glass-hover);
      transform: scale(0.95);
    }

    .icon-btn.quit {
      border-color: rgba(239, 68, 68, 0.3);
      color: var(--error);
    }

    .bottom-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .quit-online-btn {
      position: absolute;
      bottom: calc(16px + var(--safe-bottom));
      left: 16px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- WELCOME SCREEN -->
  <div class="screen visible" id="welcomeScreen">
    <div class="screen-content">
      <h1 class="welcome-title">Geo Master</h1>
      <p class="welcome-subtitle">Online Photo Contest</p>
      
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-value" id="onlineCount">0</div>
          <div class="stat-label">Online</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="gamesPlayed">0</div>
          <div class="stat-label">Games</div>
        </div>
      </div>

      <button class="online-btn" id="onlineBtn">Online Mode</button>
      <button class="main-btn no-anim" id="soloBtn">Solo Practice</button>
    </div>
  </div>

  <!-- ONLINE MENU SCREEN -->
  <div class="screen" id="onlineMenuScreen">
    <button class="back-btn" id="onlineMenuBackBtn">
      <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </button>
    <div class="screen-content">
      <div class="section-title">Online Mode</div>
      
      <input type="text" class="name-input" id="playerNameInput" placeholder="Your nickname..." maxlength="20">
      
      <button class="secondary-btn no-anim" id="googleLoginBtn" style="margin-top: 0; margin-bottom: 16px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
      </button>
      <button class="secondary-btn no-anim" id="googleLogoutBtn" style="margin-top: 0; margin-bottom: 16px; width: 100%; display: none;">Sign Out</button>
      
      <button class="main-btn no-anim" id="createRoomBtn" style="margin-bottom: 12px;">Create Room</button>
      <button class="secondary-btn no-anim" id="joinRoomBtn">Join Room</button>
    </div>
  </div>

  <!-- JOIN ROOM SCREEN -->
  <div class="screen" id="joinRoomScreen">
    <button class="back-btn" id="joinRoomBackBtn">
      <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </button>
    <div class="screen-content">
      <div class="section-title">Join Room</div>
      
      <input type="text" class="join-input" id="roomCodeInput" placeholder="CODE" maxlength="6">
      
      <button class="main-btn no-anim" id="joinRoomConfirmBtn">Join</button>
    </div>
  </div>

  <!-- LOBBY SCREEN -->
  <div class="screen" id="lobbyScreen">
    <button class="back-btn" id="lobbyBackBtn">
      <svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </button>
    <div class="screen-content">
      <div class="lobby-title">Game Lobby</div>
      <div class="lobby-code" id="lobbyCode">ABCD12</div>
      <button class="copy-code-btn" id="copyCodeBtn">Copy Code</button>
      
      <div class="players-list" id="playersList"></div>
      
      <div class="waiting-text" id="waitingText">Waiting for players...</div>
      
      <button class="main-btn no-anim" id="startOnlineGameBtn">Start Game</button>
    </div>
  </div>

  <!-- COUNTDOWN SCREEN -->
  <div class="screen" id="countdownScreen">
    <div class="screen-content">
      <div class="countdown-number" id="countdownNumber">3</div>
      <div class="countdown-text">Get Ready</div>
    </div>
  </div>

  <!-- ONLINE GAME UI -->
  <div class="online-game-ui" id="onlineGameUI">
    <div class="online-top-bar">
      <div class="online-timer-box" id="onlineTimerDisplay">01:00</div>
      <div class="online-status" id="onlineStatus">Find the best view!</div>
    </div>

    <div class="spacer"></div>

    <div class="photo-captured" id="photoCaptured" style="display: none;">
      <img id="capturedPreview" src="" alt="Captured">
    </div>

    <div class="bottom-controls">
      <button class="capture-btn" id="captureBtn">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>
      </button>
      <div class="capture-hint" id="captureHint">Press to capture the best view</div>
    </div>

    <button class="icon-btn quit quit-online-btn" id="quitOnlineBtn">
      <svg class="icon" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button>
  </div>

  <!-- VOTING SCREEN -->
  <div class="screen" id="votingScreen">
    <div class="screen-content" style="max-width: 600px;">
      <div class="voting-title">Vote for the Best Photo!</div>
      <div class="voting-timer" id="votingTimer">10</div>
      
      <div class="photos-grid" id="photosGrid"></div>
    </div>
  </div>

  <!-- WINNER SCREEN -->
  <div class="screen" id="winnerScreen">
    <div class="screen-content">
      <div class="winner-crown">ðŸ‘‘</div>
      <div class="winner-title">Winner!</div>
      <div class="winner-name" id="winnerName">Player Name</div>
      
      <div class="winner-photo" id="winnerPhotoContainer">
        <img id="winnerPhoto" src="" alt="Winner">
      </div>
      
      <div class="winner-votes" id="winnerVotes">5 votes</div>
      
      <button class="main-btn no-anim" id="playAgainOnlineBtn">Play Again</button>
      <button class="secondary-btn no-anim" id="backToLobbyBtn">Back to Lobby</button>
    </div>
  </div>

  <!-- LOADING SCREEN -->
  <div class="screen" id="loadingScreen">
    <div class="screen-content">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">Connecting...</div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCbBh9ulc4_tds31MsDbiSgaHPUU3l0Qx4",
      authDomain: "maps-52b00.firebaseapp.com",
      projectId: "maps-52b00",
      storageBucket: "maps-52b00.firebasestorage.app",
      messagingSenderId: "485125559932",
      appId: "1:485125559932:web:7d304f3f2cda4ef4c21bf9",
      measurementId: "G-YHHXDYCCG7",
      databaseURL: "https://maps-52b00-default-rtdb.europe-west1.firebasedatabase.app"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // DOM Elements
    const $ = id => document.getElementById(id);

    const welcomeScreen = $("welcomeScreen");
    const onlineMenuScreen = $("onlineMenuScreen");
    const joinRoomScreen = $("joinRoomScreen");
    const lobbyScreen = $("lobbyScreen");
    const countdownScreen = $("countdownScreen");
    const onlineGameUI = $("onlineGameUI");
    const votingScreen = $("votingScreen");
    const winnerScreen = $("winnerScreen");
    const loadingScreen = $("loadingScreen");
    const toast = $("toast");

    // Map Setup
    const map = L.map("map", {
      zoomControl: false,
      worldCopyJump: true,
      minZoom: 2,
      maxZoom: 18
    }).setView([41.0082, 28.9784], 12); // Istanbul

    L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
      maxZoom: 19
    }).addTo(map);

    // Game State
    let currentRoomId = null;
    let currentPlayerId = null;
    let playerName = "";
    let isHost = false;
    let uid = null;
    let gameTimer = null;
    let votingTimer = null;
    let capturedPhoto = null;
    let hasVoted = false;
    let roomListener = null;

    // Google Login
    async function loginWithGoogle() {
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        console.error("Popup failed, trying redirect:", error);
        // iOS popup sorunu icin redirect kullan
        signInWithRedirect(auth, provider);
      }
    }

    // Google Logout
    async function logout() {
      if (currentRoomId) {
        await leaveRoom();
      }
      try {
        await signOut(auth);
        showToast("Signed out", "success");
      } catch (error) {
        console.error("Logout error:", error);
      }
    }

    // Check redirect result on page load
    getRedirectResult(auth).then((result) => {
      if (result && result.user) {
        showToast("Signed in!", "success");
      }
    }).catch((error) => {
      console.error("Redirect result error:", error);
    });

    // Presence system
    let presenceRef = null;

    function setupPresence(user) {
      if (!user) return;

      const userName = user.displayName || "Anonymous";
      presenceRef = ref(db, `presence/${user.uid}`);
      
      // Connection state reference
      const connectedRef = ref(db, ".info/connected");
      
      onValue(connectedRef, (snapshot) => {
        if (snapshot.val() === true) {
          // Set online status
          set(presenceRef, {
            uid: user.uid,
            name: userName.slice(0, 20),
            roomId: currentRoomId || "lobby",
            online: true,
            lastSeen: Date.now()
          });

          // When disconnected, update status
          onDisconnect(presenceRef).set({
            uid: user.uid,
            name: userName.slice(0, 20),
            roomId: "lobby",
            online: false,
            lastSeen: Date.now()
          });
        }
      });
    }

    function updatePresenceRoom(roomId) {
      if (!presenceRef || !auth.currentUser) return;
      update(presenceRef, {
        roomId: roomId || "lobby",
        lastSeen: Date.now()
      });
    }

    // Listen to online users count
    function listenToOnlineUsers() {
      const presenceListRef = ref(db, "presence");
      onValue(presenceListRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          const onlineUsers = Object.values(data).filter(u => u.online === true);
          $("onlineCount").textContent = onlineUsers.length;
        } else {
          $("onlineCount").textContent = "0";
        }
      });
    }

    // Start listening to online users
    listenToOnlineUsers();

    // Auth state listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        uid = user.uid;
        currentPlayerId = uid;
        
        // Auto-fill name input
        if (user.displayName) {
          $("playerNameInput").value = user.displayName.slice(0, 20);
        }
        
        // Toggle buttons
        $("googleLoginBtn").style.display = "none";
        $("googleLogoutBtn").style.display = "block";

        // Setup presence
        setupPresence(user);
      } else {
        uid = null;
        currentPlayerId = null;
        presenceRef = null;
        
        // Toggle buttons
        $("googleLoginBtn").style.display = "flex";
        $("googleLogoutBtn").style.display = "none";
      }
    });

    // Generate Room Code
    function generateRoomCode() {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let code = "";
      for (let i = 0; i < 6; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return code;
    }

    // Generate Player ID
    function generatePlayerId() {
      return "player_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
    }

    // Show Toast
    function showToast(msg, type = "") {
      toast.textContent = msg;
      toast.className = "toast visible " + type;
      setTimeout(() => toast.className = "toast", 2000);
    }

    // Show Screen
    function showScreen(screen) {
      [welcomeScreen, onlineMenuScreen, joinRoomScreen, lobbyScreen, countdownScreen, votingScreen, winnerScreen, loadingScreen].forEach(s => {
        s.classList.remove("visible");
      });
      if (screen) screen.classList.add("visible");
    }

    // Format Time
    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    // Create Room
    async function createRoom() {
      // Check if logged in
      if (!currentPlayerId) {
        showToast("Sign in with Google first!", "error");
        return;
      }

      const inputName = $("playerNameInput").value.trim();
      playerName = inputName || (auth.currentUser?.displayName?.slice(0, 20)) || "Player";
      
      if (!playerName) {
        showToast("Enter your name!", "error");
        return;
      }

      showScreen(loadingScreen);
      $("loadingText").textContent = "Creating room...";

      const roomCode = generateRoomCode();
      currentRoomId = roomCode;
      isHost = true;

      const roomRef = ref(db, `rooms/${roomCode}`);
      
      try {
        await set(roomRef, {
          code: roomCode,
          hostId: currentPlayerId,
          status: "waiting",
          createdAt: Date.now(),
          gameTime: 60,
          votingTime: 10,
          players: {
            [currentPlayerId]: {
              name: playerName,
              isHost: true,
              photo: null,
              votes: 0,
              hasVoted: false,
              joinedAt: Date.now()
            }
          }
        });

        // Set up disconnect handler
        const playerRef = ref(db, `rooms/${roomCode}/players/${currentPlayerId}`);
        onDisconnect(playerRef).remove();

        // Update presence
        updatePresenceRoom(roomCode);

        enterLobby(roomCode);
      } catch (error) {
        console.error(error);
        showToast("Failed to create room", "error");
        showScreen(onlineMenuScreen);
      }
    }

    // Join Room
    async function joinRoom() {
      // Check if logged in
      if (!currentPlayerId) {
        showToast("Sign in with Google first!", "error");
        return;
      }

      const roomCode = $("roomCodeInput").value.trim().toUpperCase();
      if (!roomCode || roomCode.length !== 6) {
        showToast("Enter valid room code!", "error");
        return;
      }

      const inputName = $("playerNameInput").value.trim();
      playerName = inputName || (auth.currentUser?.displayName?.slice(0, 20)) || "Player";

      showScreen(loadingScreen);
      $("loadingText").textContent = "Joining room...";

      currentRoomId = roomCode;
      isHost = false;

      const roomRef = ref(db, `rooms/${roomCode}`);
      
      try {
        const snapshot = await get(roomRef);
        if (!snapshot.exists()) {
          showToast("Room not found!", "error");
          showScreen(joinRoomScreen);
          return;
        }

        const roomData = snapshot.val();
        if (roomData.status !== "waiting") {
          showToast("Game already started!", "error");
          showScreen(joinRoomScreen);
          return;
        }

        // Add player
        const playerRef = ref(db, `rooms/${roomCode}/players/${currentPlayerId}`);
        await set(playerRef, {
          name: playerName,
          isHost: false,
          photo: null,
          votes: 0,
          hasVoted: false,
          joinedAt: Date.now()
        });

        // Set up disconnect handler
        onDisconnect(playerRef).remove();

        // Update presence
        updatePresenceRoom(roomCode);

        enterLobby(roomCode);
      } catch (error) {
        console.error(error);
        showToast("Failed to join room", "error");
        showScreen(joinRoomScreen);
      }
    }

    // Enter Lobby
    function enterLobby(roomCode) {
      $("lobbyCode").textContent = roomCode;
      showScreen(lobbyScreen);

      // Show/hide start button based on host
      $("startOnlineGameBtn").style.display = isHost ? "block" : "none";

      // Listen to room changes
      const roomRef = ref(db, `rooms/${roomCode}`);
      
      if (roomListener) {
        roomListener();
      }

      roomListener = onValue(roomRef, (snapshot) => {
        if (!snapshot.exists()) {
          showToast("Room closed", "error");
          leaveRoom();
          return;
        }

        const roomData = snapshot.val();
        
        // Update players list
        renderPlayersList(roomData.players);

        // Handle game state changes
        if (roomData.status === "countdown") {
          startCountdown(roomData);
        } else if (roomData.status === "playing") {
          if (!onlineGameUI.classList.contains("visible")) {
            startOnlineGame(roomData);
          }
        } else if (roomData.status === "voting") {
          startVoting(roomData);
        } else if (roomData.status === "results") {
          showResults(roomData);
        }
      });
    }

    // Render Players List
    function renderPlayersList(players) {
      const list = $("playersList");
      list.innerHTML = "";

      if (!players) return;

      const playerCount = Object.keys(players).length;
      $("waitingText").textContent = `${playerCount} player${playerCount > 1 ? "s" : ""} in lobby`;

      Object.entries(players).forEach(([id, player]) => {
        const item = document.createElement("div");
        item.className = "player-item";
        
        const initial = player.name.charAt(0).toUpperCase();
        
        item.innerHTML = `
          <div class="player-avatar">${initial}</div>
          <div class="player-name">${player.name}</div>
          ${player.isHost ? '<div class="player-host">HOST</div>' : ''}
        `;
        
        list.appendChild(item);
      });
    }

    // Start Game (Host only)
    async function startGameFromLobby() {
      if (!isHost) return;

      const roomRef = ref(db, `rooms/${currentRoomId}`);
      await update(roomRef, {
        status: "countdown",
        countdownStart: Date.now()
      });
    }

    // Start Countdown
    function startCountdown(roomData) {
      showScreen(countdownScreen);
      onlineGameUI.classList.remove("visible");
      
      let count = 3;
      const countdownNumber = $("countdownNumber");
      countdownNumber.textContent = count;
      countdownNumber.style.animation = "none";
      void countdownNumber.offsetWidth;
      countdownNumber.style.animation = "countPop 0.9s cubic-bezier(0.16, 1, 0.3, 1) forwards";

      const interval = setInterval(async () => {
        count--;
        if (count > 0) {
          countdownNumber.textContent = count;
          countdownNumber.style.animation = "none";
          void countdownNumber.offsetWidth;
          countdownNumber.style.animation = "countPop 0.9s cubic-bezier(0.16, 1, 0.3, 1) forwards";
        } else {
          clearInterval(interval);
          
          // Only host updates status
          if (isHost) {
            const roomRef = ref(db, `rooms/${currentRoomId}`);
            await update(roomRef, {
              status: "playing",
              gameStartTime: Date.now()
            });
          }
        }
      }, 1000);
    }

    // Start Online Game
    function startOnlineGame(roomData) {
      showScreen(null);
      onlineGameUI.classList.add("visible");
      
      capturedPhoto = null;
      $("photoCaptured").style.display = "none";
      $("captureBtn").disabled = false;
      hasVoted = false;

      // Random location
      const locations = [
        [41.0082, 28.9784, 14], // Istanbul
        [48.8566, 2.3522, 14], // Paris
        [40.7128, -74.0060, 14], // New York
        [35.6762, 139.6503, 14], // Tokyo
        [51.5074, -0.1278, 14], // London
        [-33.8688, 151.2093, 14], // Sydney
        [55.7558, 37.6173, 14], // Moscow
        [25.2048, 55.2708, 14], // Dubai
        [52.5200, 13.4050, 14], // Berlin
        [41.9028, 12.4964, 14], // Rome
      ];
      
      const randomLoc = locations[Math.floor(Math.random() * locations.length)];
      map.setView([randomLoc[0], randomLoc[1]], randomLoc[2]);

      // Start timer
      let timeLeft = roomData.gameTime || 60;
      $("onlineTimerDisplay").textContent = formatTime(timeLeft);
      $("onlineTimerDisplay").classList.remove("warning");

      if (gameTimer) clearInterval(gameTimer);
      
      gameTimer = setInterval(async () => {
        timeLeft--;
        $("onlineTimerDisplay").textContent = formatTime(timeLeft);
        
        if (timeLeft <= 10) {
          $("onlineTimerDisplay").classList.add("warning");
        }
        
        if (timeLeft <= 0) {
          clearInterval(gameTimer);
          
          // Only host updates status
          if (isHost) {
            const roomRef = ref(db, `rooms/${currentRoomId}`);
            await update(roomRef, {
              status: "voting",
              votingStartTime: Date.now()
            });
          }
        }
      }, 1000);
    }

    // Capture Photo
    async function capturePhoto() {
      $("captureBtn").disabled = true;
      $("captureHint").textContent = "Capturing...";

      try {
        // Hide UI temporarily
        onlineGameUI.style.opacity = "0";
        
        await new Promise(r => setTimeout(r, 100));
        
        const canvas = await html2canvas(document.getElementById("map"), {
          useCORS: true,
          allowTaint: true,
          logging: false
        });
        
        onlineGameUI.style.opacity = "1";
        
        capturedPhoto = canvas.toDataURL("image/jpeg", 0.6);
        
        // Show preview
        $("capturedPreview").src = capturedPhoto;
        $("photoCaptured").style.display = "block";
        
        // Save to Firebase
        const photoRef = ref(db, `rooms/${currentRoomId}/players/${currentPlayerId}/photo`);
        await set(photoRef, capturedPhoto);
        
        $("captureHint").textContent = "Photo captured! You can capture again.";
        $("captureBtn").disabled = false;
        
        showToast("Photo captured!", "success");
      } catch (error) {
        console.error(error);
        onlineGameUI.style.opacity = "1";
        $("captureHint").textContent = "Failed. Try again.";
        $("captureBtn").disabled = false;
        showToast("Capture failed", "error");
      }
    }

    // Start Voting
    function startVoting(roomData) {
      if (gameTimer) clearInterval(gameTimer);
      
      showScreen(votingScreen);
      onlineGameUI.classList.remove("visible");
      
      const grid = $("photosGrid");
      grid.innerHTML = "";
      
      if (!roomData.players) return;

      // Render all photos
      Object.entries(roomData.players).forEach(([id, player]) => {
        if (!player.photo) return;
        
        const card = document.createElement("div");
        card.className = "photo-card";
        card.dataset.playerId = id;
        
        card.innerHTML = `
          <img src="${player.photo}" alt="${player.name}">
          <div class="photo-card-info">
            <div class="photo-card-name">${player.name}</div>
            <div class="photo-card-votes">${player.votes || 0} votes</div>
          </div>
        `;
        
        if (id !== currentPlayerId) {
          card.addEventListener("click", () => voteForPhoto(id));
        } else {
          card.style.opacity = "0.6";
          card.style.cursor = "not-allowed";
        }
        
        grid.appendChild(card);
      });

      // Start voting timer
      let votingTimeLeft = roomData.votingTime || 10;
      $("votingTimer").textContent = votingTimeLeft;

      if (votingTimer) clearInterval(votingTimer);
      
      votingTimer = setInterval(async () => {
        votingTimeLeft--;
        $("votingTimer").textContent = votingTimeLeft;
        
        if (votingTimeLeft <= 0) {
          clearInterval(votingTimer);
          
          // Only host updates status
          if (isHost) {
            const roomRef = ref(db, `rooms/${currentRoomId}`);
            await update(roomRef, {
              status: "results"
            });
          }
        }
      }, 1000);
    }

    // Vote for Photo
    async function voteForPhoto(playerId) {
      if (hasVoted) {
        showToast("Already voted!", "error");
        return;
      }
      
      hasVoted = true;
      
      // Update UI
      document.querySelectorAll(".photo-card").forEach(card => {
        card.classList.remove("selected");
        if (card.dataset.playerId === playerId) {
          card.classList.add("selected");
        }
      });
      
      // Update vote count in Firebase
      const playerRef = ref(db, `rooms/${currentRoomId}/players/${playerId}`);
      const snapshot = await get(playerRef);
      if (snapshot.exists()) {
        const currentVotes = snapshot.val().votes || 0;
        await update(playerRef, { votes: currentVotes + 1 });
      }
      
      // Mark as voted
      const myRef = ref(db, `rooms/${currentRoomId}/players/${currentPlayerId}`);
      await update(myRef, { hasVoted: true });
      
      showToast("Vote submitted!", "success");
    }

    // Show Results
    function showResults(roomData) {
      if (votingTimer) clearInterval(votingTimer);
      
      showScreen(winnerScreen);
      
      if (!roomData.players) return;

      // Find winner
      let winner = null;
      let maxVotes = -1;
      
      Object.entries(roomData.players).forEach(([id, player]) => {
        if ((player.votes || 0) > maxVotes) {
          maxVotes = player.votes || 0;
          winner = { id, ...player };
        }
      });

      if (winner && winner.photo) {
        $("winnerName").textContent = winner.name;
        $("winnerPhoto").src = winner.photo;
        $("winnerVotes").textContent = `${maxVotes} vote${maxVotes !== 1 ? "s" : ""}`;
        $("winnerPhotoContainer").style.display = "block";
      } else {
        $("winnerName").textContent = "No winner";
        $("winnerPhotoContainer").style.display = "none";
        $("winnerVotes").textContent = "No photos submitted";
      }
    }

    // Leave Room
    async function leaveRoom() {
      if (roomListener) {
        roomListener();
        roomListener = null;
      }
      
      if (gameTimer) clearInterval(gameTimer);
      if (votingTimer) clearInterval(votingTimer);
      
      if (currentRoomId && currentPlayerId) {
        try {
          const playerRef = ref(db, `rooms/${currentRoomId}/players/${currentPlayerId}`);
          await remove(playerRef);
          
          // If host leaves and room is waiting, delete room
          if (isHost) {
            const roomRef = ref(db, `rooms/${currentRoomId}`);
            const snapshot = await get(roomRef);
            if (snapshot.exists()) {
              const players = snapshot.val().players;
              if (!players || Object.keys(players).length === 0) {
                await remove(roomRef);
              }
            }
          }
        } catch (e) {
          console.error(e);
        }
      }
      
      // Update presence back to lobby
      updatePresenceRoom("lobby");

      currentRoomId = null;
      currentPlayerId = uid; // Keep uid for presence
      isHost = false;
      capturedPhoto = null;
      hasVoted = false;
      
      onlineGameUI.classList.remove("visible");
      showScreen(welcomeScreen);
    }

    // Play Again
    async function playAgain() {
      if (!currentRoomId) return;
      
      // Reset player data
      const playerRef = ref(db, `rooms/${currentRoomId}/players/${currentPlayerId}`);
      await update(playerRef, {
        photo: null,
        votes: 0,
        hasVoted: false
      });
      
      // Only host resets game
      if (isHost) {
        const roomRef = ref(db, `rooms/${currentRoomId}`);
        
        // Reset all players
        const snapshot = await get(roomRef);
        if (snapshot.exists()) {
          const players = snapshot.val().players;
          const updates = {};
          Object.keys(players).forEach(id => {
            updates[`players/${id}/photo`] = null;
            updates[`players/${id}/votes`] = 0;
            updates[`players/${id}/hasVoted`] = false;
          });
          updates.status = "countdown";
          updates.countdownStart = Date.now();
          
          await update(roomRef, updates);
        }
      }
    }

    // Back to Lobby
    async function backToLobby() {
      if (!currentRoomId) return;
      
      // Reset player data
      const playerRef = ref(db, `rooms/${currentRoomId}/players/${currentPlayerId}`);
      await update(playerRef, {
        photo: null,
        votes: 0,
        hasVoted: false
      });
      
      // Only host resets game
      if (isHost) {
        const roomRef = ref(db, `rooms/${currentRoomId}`);
        
        const snapshot = await get(roomRef);
        if (snapshot.exists()) {
          const players = snapshot.val().players;
          const updates = {};
          Object.keys(players).forEach(id => {
            updates[`players/${id}/photo`] = null;
            updates[`players/${id}/votes`] = 0;
            updates[`players/${id}/hasVoted`] = false;
          });
          updates.status = "waiting";
          
          await update(roomRef, updates);
        }
      }
      
      capturedPhoto = null;
      hasVoted = false;
      showScreen(lobbyScreen);
    }

    // Event Listeners
    $("onlineBtn").addEventListener("click", () => {
      showScreen(onlineMenuScreen);
    });

    $("soloBtn").addEventListener("click", () => {
      showToast("Solo mode coming soon!", "");
    });

    $("onlineMenuBackBtn").addEventListener("click", () => {
      showScreen(welcomeScreen);
    });

    $("googleLoginBtn").addEventListener("click", loginWithGoogle);
    $("googleLogoutBtn").addEventListener("click", logout);

    $("createRoomBtn").addEventListener("click", createRoom);

    $("joinRoomBtn").addEventListener("click", () => {
      playerName = $("playerNameInput").value.trim();
      if (!playerName) {
        showToast("Enter your name first!", "error");
        return;
      }
      showScreen(joinRoomScreen);
    });

    $("joinRoomBackBtn").addEventListener("click", () => {
      showScreen(onlineMenuScreen);
    });

    $("joinRoomConfirmBtn").addEventListener("click", joinRoom);

    $("roomCodeInput").addEventListener("input", (e) => {
      e.target.value = e.target.value.toUpperCase();
    });

    $("lobbyBackBtn").addEventListener("click", leaveRoom);

    $("copyCodeBtn").addEventListener("click", () => {
      navigator.clipboard.writeText(currentRoomId).then(() => {
        showToast("Code copied!", "success");
      });
    });

    $("startOnlineGameBtn").addEventListener("click", startGameFromLobby);

    $("captureBtn").addEventListener("click", capturePhoto);

    $("quitOnlineBtn").addEventListener("click", leaveRoom);

    $("playAgainOnlineBtn").addEventListener("click", playAgain);

    $("backToLobbyBtn").addEventListener("click", backToLobby);

    // Update online count
    const roomsRef = ref(db, "rooms");
    onValue(roomsRef, (snapshot) => {
      let onlineCount = 0;
      let gamesCount = 0;
      
      if (snapshot.exists()) {
        const rooms = snapshot.val();
        Object.values(rooms).forEach(room => {
          if (room.players) {
            onlineCount += Object.keys(room.players).length;
          }
          gamesCount++;
        });
      }
      
      $("onlineCount").textContent = onlineCount;
      $("gamesPlayed").textContent = gamesCount;
    });
  </script>
</body>
</html>
