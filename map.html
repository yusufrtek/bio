<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Ülke Oyunu</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --panel: rgba(255,255,255,.92);
      --panel2: rgba(255,255,255,.78);
      --border: rgba(0,0,0,.10);
      --shadow: 0 24px 80px rgba(0,0,0,.35);
      --radius: 20px;
      --radius2: 16px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
      --safe-right: env(safe-area-inset-right);
    }

    *{ box-sizing: border-box; }
    html, body { height:100%; margin:0; }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow: hidden;
      background: #0b0f19;
    }
    #map{ position: fixed; inset: 0; }

    /* Overlay base */
    .ui{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      display: grid;
      grid-template-rows: auto 1fr auto;
      padding: calc(12px + var(--safe-top)) calc(12px + var(--safe-right)) calc(12px + var(--safe-bottom)) calc(12px + var(--safe-left));
      gap: 10px;
    }

    /* HUD top */
    .hud{
      pointer-events: auto;
      width: min(900px, 100%);
      justify-self: center;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }

    .chip{
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: 999px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .logo{
      width: 36px; height: 36px;
      border-radius: 14px;
      background: rgba(0,0,0,.92);
      color: #fff;
      display:grid; place-items:center;
      font-weight: 1000;
      flex: 0 0 auto;
      letter-spacing: .5px;
    }
    .brandText{
      min-width:0;
      display:flex;
      flex-direction: column;
    }
    .title{
      font-weight: 1000;
      font-size: 14px;
      line-height: 1.15;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sub{
      font-size: 12px;
      opacity: .75;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stats{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      flex-wrap: wrap;
    }
    .stat{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      font-weight: 1000;
      font-size: 13px;
      white-space: nowrap;
    }

    /* Bottom action bar */
    .bar{
      pointer-events: auto;
      width: min(900px, 100%);
      justify-self: center;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: end;
    }

    .prompt{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }

    .promptTitle{
      font-weight: 1000;
      font-size: 14px;
      opacity: .9;
    }
    .promptText{
      font-size: 14px;
      font-weight: 1000;
      line-height: 1.25;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .hint{
      font-size: 12px;
      opacity: .7;
      line-height: 1.25;
    }

    .controls{
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    input{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.95);
      outline: none;
      font-size: 15px;
    }
    .row{
      display:flex; gap:10px; align-items:center;
      flex-wrap: wrap;
    }

    button{
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(0,0,0,.92);
      color: #fff;
      font-weight: 1000;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease;
    }
    button.secondary{
      background: rgba(255,255,255,.9);
      color: #111;
    }
    button:active{ transform: scale(.99); }

    /* Multiple choice grid */
    .choices{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 2px;
    }
    .choiceBtn{
      background: rgba(255,255,255,.92);
      color: #111;
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 14px 40px rgba(0,0,0,.10);
      text-align: left;
      min-height: 48px;
      border-radius: 14px;
      padding: 12px;
      font-weight: 1000;
    }

    /* Toast */
    .toast{
      pointer-events: none;
      justify-self: center;
      width: min(900px, 100%);
      display:flex;
      justify-content:center;
    }
    .toast > div{
      background: rgba(0,0,0,.82);
      color:#fff;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      opacity: 0;
      transform: translateY(-6px);
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show > div{ opacity: 1; transform: translateY(0); }

    /* Fullscreen screens */
    .screen{
      position: fixed;
      inset: 0;
      z-index: 10000;
      display: grid;
      place-items: center;
      padding: 16px;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(0,0,0,.20), transparent),
        radial-gradient(900px 600px at 80% 35%, rgba(0,0,0,.16), transparent),
        rgba(0,0,0,.45);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }
    .card{
      width: min(940px, 100%);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 16px;
      overflow: hidden;
    }
    .hero{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-bottom: 10px;
    }
    .hero .bigLogo{
      width: 54px; height: 54px;
      border-radius: 20px;
      background: rgba(0,0,0,.92);
      color:#fff;
      display:grid; place-items:center;
      font-weight: 1000;
      font-size: 18px;
      flex: 0 0 auto;
    }
    .hero h1{
      margin: 0;
      font-size: 20px;
      font-weight: 1000;
      line-height: 1.2;
    }
    .hero p{
      margin: 6px 0 0;
      opacity: .8;
      line-height: 1.35;
      font-size: 13px;
    }

    .modes{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .modeBtn{
      text-align: left;
      border-radius: var(--radius2);
      padding: 14px;
      background: rgba(255,255,255,.9);
      color:#111;
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 14px 40px rgba(0,0,0,.12);
    }
    .modeBtn strong{
      display:block;
      font-size: 15px;
      font-weight: 1000;
      margin-bottom: 6px;
    }
    .modeBtn span{
      display:block;
      font-size: 12px;
      opacity: .78;
      line-height: 1.35;
    }

    .small{
      font-size: 12px;
      opacity: .75;
      line-height: 1.35;
    }

    @media (min-width: 900px){
      .modes{ grid-template-columns: 1fr 1fr; }
    }
    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- START SCREEN -->
  <div class="screen" id="startScreen">
    <div class="card">
      <div class="hero">
        <div class="bigLogo">MAP</div>
        <div>
          <h1>Ülke Oyunu</h1>
          <p>2 dakika içinde olabildiğince çok doğru yap. Doğru = 1 puan. Yanlışta ülke kırmızı yanar. “Geç” ile soruyu atlayıp devam edebilirsin.</p>
        </div>
      </div>

      <div class="modes">
        <button class="modeBtn" id="modeType">
          <strong>Mod 1 — Yaz (Öğretici)</strong>
          <span>Haritada ülke seçili ve vurgulu gelir. Sen ülkenin adını yazarsın. Doğruysa yeşil olur.</span>
        </button>

        <button class="modeBtn" id="modeClick">
          <strong>Mod 2 — Seç (Gerçek Bulma)</strong>
          <span>Ülke adı yazılı gelir. Harita hedefi asla göstermez: zoom yok, vurgu yok. Sen bulup dokunursun.</span>
        </button>

        <button class="modeBtn" id="modeChoice">
          <strong>Mod 3 — 4 Şık</strong>
          <span>Haritada ülke vurgulu gelir; altta 4 seçenek çıkar. Doğru şıkkı seç.</span>
        </button>

        <button class="modeBtn" id="modeHard">
          <strong>Mod 4 — Zor (Seç + Ceza)</strong>
          <span>Mod 2 gibi: hedef asla belli olmaz. Yanlış tıkta -1 puan (minimum 0). Hız ve dikkat modu.</span>
        </button>
      </div>

      <div class="small" style="margin-top:10px;">
        Gerekli dosya: <b>countries.geojson</b> (index.html ile aynı klasörde). Kod şunu okur: <code>./countries.geojson</code>
      </div>
    </div>
  </div>

  <!-- GAME OVER -->
  <div class="screen" id="overScreen" style="display:none;">
    <div class="card">
      <div class="hero">
        <div class="bigLogo">GG</div>
        <div>
          <h1>Oyun Bitti</h1>
          <p id="overText">Skorun: 0</p>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="playAgain">Tekrar Oyna</button>
        <button class="secondary" id="backToMenu">Mod Seçimine Dön</button>
      </div>

      <div class="small" style="margin-top:10px;">
        İstersen sonraki adım: kıta filtreleri, combo, en iyi skor (localStorage), “Türkiye = Turkey” gibi eş anlamlılar.
      </div>
    </div>
  </div>

  <!-- HUD / IN-GAME UI -->
  <div class="ui" id="gameUI" style="display:none;">
    <div class="hud">
      <div class="chip brand">
        <div class="logo">TR</div>
        <div class="brandText">
          <div class="title" id="modeTitle">Mod</div>
          <div class="sub" id="modeSub">Hazırlanıyor…</div>
        </div>
      </div>

      <div class="stats">
        <div class="stat" id="timer">02:00</div>
        <div class="stat" id="score">Puan: 0</div>
        <div class="stat" id="qcount">Soru: 0</div>
      </div>
    </div>

    <div></div>

    <div class="bar">
      <div class="prompt" id="promptBox">
        <div class="promptTitle" id="promptTitle">Soru</div>
        <div class="promptText" id="promptText">—</div>
        <div class="hint" id="promptHint">—</div>

        <!-- Typing -->
        <div class="row" id="typeRow" style="display:none;">
          <input id="answer" placeholder="Ülke adını yaz…" autocomplete="off"/>
          <button id="checkBtn">Kontrol</button>
        </div>

        <!-- Choices -->
        <div class="choices" id="choiceGrid" style="display:none;"></div>
      </div>

      <div class="controls">
        <button class="secondary" id="skipBtn">Geç</button>
        <button class="secondary" id="fitBtn">Haritayı Sığdır</button>
        <button class="secondary" id="quitBtn">Çık</button>
      </div>
    </div>

    <div class="toast" id="toast"><div id="toastText"></div></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /***********************
     * 0) AYAR
     ***********************/
    const GEOJSON_URL = "./countries.geojson";

    // GeoJSON properties field candidates
    const NAME_FIELDS = ["ADMIN","NAME","NAME_EN","NAME_LONG","SOVEREIGNT","FORMAL_EN","BRK_NAME","NAME_TR","NAME_TUR"];

    // Oyun
    const GAME_SECONDS = 120;

    /***********************
     * 1) DOM
     ***********************/
    const $ = (id) => document.getElementById(id);

    const startScreen = $("startScreen");
    const overScreen = $("overScreen");
    const overText = $("overText");

    const gameUI = $("gameUI");
    const modeTitle = $("modeTitle");
    const modeSub = $("modeSub");

    const timerEl = $("timer");
    const scoreEl = $("score");
    const qcountEl = $("qcount");

    const promptTitle = $("promptTitle");
    const promptText = $("promptText");
    const promptHint = $("promptHint");

    const typeRow = $("typeRow");
    const answerEl = $("answer");
    const checkBtn = $("checkBtn");

    const choiceGrid = $("choiceGrid");

    const skipBtn = $("skipBtn");
    const fitBtn = $("fitBtn");
    const quitBtn = $("quitBtn");

    const toastEl = $("toast");
    const toastText = $("toastText");

    const playAgainBtn = $("playAgain");
    const backToMenuBtn = $("backToMenu");

    const modeTypeBtn = $("modeType");
    const modeClickBtn = $("modeClick");
    const modeChoiceBtn = $("modeChoice");
    const modeHardBtn = $("modeHard");

    /***********************
     * 2) HARITA
     ***********************/
    const map = L.map("map", { zoomControl: true, worldCopyJump: true }).setView([20, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap"
    }).addTo(map);

    let geoLayer = null;
    let countries = []; // { layer, names[], primaryName, correct, asked }
    let allBounds = null;

    /***********************
     * 3) GAME STATE
     ***********************/
    const MODE = { TYPE: "type", CLICK: "click", CHOICE: "choice", HARD: "hard" };
    let currentMode = null;

    let running = false;
    let timeLeft = GAME_SECONDS;
    let timerHandle = null;

    let score = 0;
    let qcount = 0;

    let currentCountry = null; // answer country

    /***********************
     * 4) STYLES
     ***********************/
    function styleDefault(){
      return {
        color: "rgba(0,0,0,.30)",
        weight: 1,
        fillColor: "rgba(0,0,0,.06)",
        fillOpacity: 0.20
      };
    }
    function applyDefault(c){ c.layer.setStyle(styleDefault()); }
    function applyCorrect(c){
      c.layer.setStyle({
        color: "rgba(0,0,0,.45)",
        weight: 1,
        fillColor: "rgba(0,128,0,.55)",
        fillOpacity: 0.65
      });
    }
    function applyFocus(c){
      c.layer.setStyle({
        color: "rgba(0,0,0,.30)",     // sınır kalınlaşmasın
        weight: 1,                   // sınır kalınlaşmasın
        fillColor: "rgba(0,0,0,.10)", // hafif
        fillOpacity: 0.36
      });
    }
    function flashWrong(layer){
      const prev = { ...styleDefault() };
      layer.setStyle({
        color: "rgba(0,0,0,.45)",
        weight: 1,
        fillColor: "rgba(200,0,0,.65)",
        fillOpacity: 0.72
      });
      setTimeout(() => layer.setStyle(prev), 420);
    }
    function resetAllNonCorrect(){
      countries.forEach(c => c.correct ? applyCorrect(c) : applyDefault(c));
    }

    /***********************
     * 5) HELPERS
     ***********************/
    function toast(msg){
      toastText.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 850);
    }
    function normalizeText(s){
      return String(s || "")
        .trim()
        .toLocaleLowerCase("tr-TR")
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/ı/g, "i")
        .replace(/\s+/g, " ");
    }
    function getNames(props){
      const names = [];
      for (const k of NAME_FIELDS){
        if (props && props[k]) names.push(String(props[k]));
      }
      const seen = new Set();
      return names.filter(n => {
        const x = normalizeText(n);
        if (!x || seen.has(x)) return false;
        seen.add(x);
        return true;
      });
    }
    function formatTime(sec){
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }
    function updateHUD(){
      timerEl.textContent = formatTime(timeLeft);
      scoreEl.textContent = `Puan: ${score}`;
      qcountEl.textContent = `Soru: ${qcount}`;
    }
    function fitWorld(){
      if (allBounds) map.fitBounds(allBounds.pad(0.12));
    }
    function endGame(){
      running = false;
      if (timerHandle) clearInterval(timerHandle);
      timerHandle = null;

      gameUI.style.display = "none";
      overScreen.style.display = "grid";
      overText.textContent = `Skorun: ${score}  —  Toplam soru: ${qcount}`;
      toastEl.classList.remove("show");
    }
    function quitToMenu(){
      running = false;
      if (timerHandle) clearInterval(timerHandle);
      timerHandle = null;

      gameUI.style.display = "none";
      overScreen.style.display = "none";
      startScreen.style.display = "grid";

      countries.forEach(c => { c.correct = false; c.asked = false; applyDefault(c); });
      currentCountry = null;

      score = 0; qcount = 0;
      timeLeft = GAME_SECONDS;
      updateHUD();
      fitWorld();
      renderChoices([]); // clear
    }
    function startTimer(){
      timeLeft = GAME_SECONDS;
      updateHUD();
      if (timerHandle) clearInterval(timerHandle);
      timerHandle = setInterval(() => {
        if (!running) return;
        timeLeft -= 1;
        if (timeLeft < 0) timeLeft = 0;
        updateHUD();
        if (timeLeft === 0) endGame();
      }, 1000);
    }

    /***********************
     * 6) QUESTION GEN
     ***********************/
    function pickNextCountry(){
      let pool = countries.filter(c => !c.asked);
      if (pool.length === 0){
        countries.forEach(c => c.asked = false);
        pool = countries.slice();
      }
      const next = pool[Math.floor(Math.random() * pool.length)];
      next.asked = true;
      return next;
    }

    function renderChoices(options){
      choiceGrid.innerHTML = "";
      if (!options.length) return;
      options.forEach(opt => {
        const b = document.createElement("button");
        b.className = "choiceBtn";
        b.textContent = opt.label;
        b.addEventListener("click", () => opt.onPick());
        choiceGrid.appendChild(b);
      });
    }

    function getDisplayName(c){
      return c.primaryName || c.names[0] || "Unknown";
    }

    function newQuestion(){
      if (!running || !countries.length) return;

      currentCountry = pickNextCountry();
      qcount += 1;
      updateHUD();

      // reset visuals
      resetAllNonCorrect();

      // UI resets
      typeRow.style.display = "none";
      choiceGrid.style.display = "none";
      renderChoices([]);
      answerEl.value = "";

      // MODE LOGIC
      if (currentMode === MODE.TYPE){
        // show & teach: highlight + zoom
        applyFocus(currentCountry);
        map.fitBounds(currentCountry.layer.getBounds().pad(0.25), { animate: true });

        promptTitle.textContent = "Ülke adını yaz";
        promptText.textContent = "Bu ülke hangi ülke?";
        promptHint.textContent = "Doğru yazınca yeşile döner.";
        typeRow.style.display = "flex";
        answerEl.focus();

      } else if (currentMode === MODE.CLICK || currentMode === MODE.HARD){
        // IMPORTANT: NO zoom, NO highlight, NO hints on map
        // map stays wherever the user is
        const name = getDisplayName(currentCountry);

        promptTitle.textContent = (currentMode === MODE.HARD) ? "Haritada ülkeyi seç (Ceza Modu)" : "Haritada ülkeyi seç";
        promptText.textContent = name;
        promptHint.textContent = (currentMode === MODE.HARD)
          ? "Yanlış tık: -1 puan (min 0). Hedef asla belli olmaz."
          : "Hedef asla belli olmaz: zoom yok, vurgu yok.";

      } else if (currentMode === MODE.CHOICE){
        // highlight + zoom, answer by 4 options
        applyFocus(currentCountry);
        map.fitBounds(currentCountry.layer.getBounds().pad(0.25), { animate: true });

        const correctName = getDisplayName(currentCountry);

        // pick 3 random wrong names
        const pool = countries.filter(c => c !== currentCountry);
        const wrongs = [];
        while (wrongs.length < 3 && pool.length){
          const pick = pool[Math.floor(Math.random() * pool.length)];
          const n = getDisplayName(pick);
          if (n && !wrongs.includes(n) && n !== correctName) wrongs.push(n);
        }

        const labels = [correctName, ...wrongs].slice(0,4);
        shuffleInPlace(labels);

        promptTitle.textContent = "4 Şık";
        promptText.textContent = "Bu ülkenin adı hangisi?";
        promptHint.textContent = "Doğru şıkkı seç.";
        choiceGrid.style.display = "grid";

        renderChoices(labels.map(lbl => ({
          label: lbl,
          onPick: () => {
            if (!running) return;
            if (normalizeText(lbl) === normalizeText(correctName)){
              score += 1;
              currentCountry.correct = true;
              applyCorrect(currentCountry);
              toast("Doğru ✅");
              updateHUD();
              setTimeout(newQuestion, 520);
            } else {
              flashWrong(currentCountry.layer);
              toast("Yanlış ❌");
            }
          }
        })));
      }
    }

    /***********************
     * 7) ANSWER LOGIC
     ***********************/
    function acceptTypedAnswer(){
      if (!running || currentMode !== MODE.TYPE || !currentCountry) return;

      const typed = normalizeText(answerEl.value);
      if (!typed){
        toast("Bir ülke adı yaz.");
        return;
      }
      const ok = currentCountry.names.some(n => normalizeText(n) === typed);
      if (ok){
        score += 1;
        currentCountry.correct = true;
        applyCorrect(currentCountry);
        toast("Doğru ✅");
        updateHUD();
        setTimeout(newQuestion, 520);
      } else {
        flashWrong(currentCountry.layer);
        toast("Yanlış ❌");
      }
    }

    function handleMapClickOnCountry(clickedCountry){
      if (!running || !currentCountry) return;
      if (currentMode !== MODE.CLICK && currentMode !== MODE.HARD) return;

      if (clickedCountry === currentCountry){
        score += 1;
        currentCountry.correct = true;
        applyCorrect(currentCountry);
        toast("Doğru ✅");
        updateHUD();
        setTimeout(newQuestion, 520);
      } else {
        flashWrong(clickedCountry.layer);
        if (currentMode === MODE.HARD){
          score = Math.max(0, score - 1);
          updateHUD();
          toast("Yanlış ❌ (-1)");
        } else {
          toast("Yanlış ❌");
        }
      }
    }

    /***********************
     * 8) START / MENU
     ***********************/
    function startGame(mode){
      currentMode = mode;

      // reset
      countries.forEach(c => { c.correct = false; c.asked = false; applyDefault(c); });
      currentCountry = null;
      score = 0;
      qcount = 0;
      updateHUD();

      // UI
      startScreen.style.display = "none";
      overScreen.style.display = "none";
      gameUI.style.display = "grid";
      toastEl.classList.remove("show");

      // Mode header
      if (mode === MODE.TYPE){
        modeTitle.textContent = "Mod 1 — Yaz";
        modeSub.textContent = "Ülke vurgulu gelir; adını yazarsın.";
      } else if (mode === MODE.CLICK){
        modeTitle.textContent = "Mod 2 — Seç";
        modeSub.textContent = "Hedef asla belli olmaz (zoom/vurgu yok).";
      } else if (mode === MODE.CHOICE){
        modeTitle.textContent = "Mod 3 — 4 Şık";
        modeSub.textContent = "Ülke vurgulu; doğru şıkkı seç.";
      } else if (mode === MODE.HARD){
        modeTitle.textContent = "Mod 4 — Zor";
        modeSub.textContent = "Bul ve seç; yanlışta -1 puan.";
      }

      // show/hide inputs
      typeRow.style.display = "none";
      choiceGrid.style.display = "none";
      renderChoices([]);

      running = true;
      startTimer();
      newQuestion();
    }

    modeTypeBtn.addEventListener("click", () => startGame(MODE.TYPE));
    modeClickBtn.addEventListener("click", () => startGame(MODE.CLICK));
    modeChoiceBtn.addEventListener("click", () => startGame(MODE.CHOICE));
    modeHardBtn.addEventListener("click", () => startGame(MODE.HARD));

    playAgainBtn.addEventListener("click", () => {
      if (!currentMode) currentMode = MODE.TYPE;
      startGame(currentMode);
    });
    backToMenuBtn.addEventListener("click", () => quitToMenu());

    checkBtn.addEventListener("click", acceptTypedAnswer);
    answerEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") acceptTypedAnswer();
    });

    skipBtn.addEventListener("click", () => {
      if (!running) return;
      toast("Geçildi → Yeni soru");
      newQuestion();
    });

    fitBtn.addEventListener("click", () => fitWorld());

    quitBtn.addEventListener("click", () => {
      toast("Çıkıldı");
      setTimeout(quitToMenu, 250);
    });

    /***********************
     * 9) GEOJSON LOAD
     ***********************/
    fetch(GEOJSON_URL)
      .then(r => {
        if (!r.ok) throw new Error("GeoJSON yüklenemedi: " + r.status);
        return r.json();
      })
      .then(geo => {
        geoLayer = L.geoJSON(geo, {
          style: styleDefault(),
          onEachFeature: (feature, layer) => {
            const names = getNames(feature.properties);
            const primaryName = names[0] || null;

            const item = { layer, feature, names, primaryName, correct: false, asked: false };
            countries.push(item);

            // IMPORTANT: Mod 2/4'te hover ipucu olmasın
            layer.on("mouseover", () => {
              if (currentMode === MODE.TYPE || currentMode === MODE.CHOICE){
                layer.setStyle({ fillOpacity: 0.32 });
              }
            });
            layer.on("mouseout", () => {
              const c = item;
              if (c.correct) applyCorrect(c);
              else if ((currentMode === MODE.TYPE || currentMode === MODE.CHOICE) && currentCountry && c === currentCountry) applyFocus(c);
              else applyDefault(c);
            });

            layer.on("click", () => handleMapClickOnCountry(item));
          }
        }).addTo(map);

        allBounds = geoLayer.getBounds();
        fitWorld();

        const unnamed = countries.filter(c => !c.names.length).length;
        if (unnamed > 0){
          console.warn("Bazı ülkelerde isim alanı bulunamadı. NAME_FIELDS listesini dosyana göre güncelleyebilirsin.");
        }
      })
      .catch(err => {
        console.error(err);
        alert(
          "countries.geojson bulunamadı veya yüklenemedi.\n\n" +
          "index.html ile aynı klasörde 'countries.geojson' olduğundan emin ol.\n" +
          "Ayrıca fetch için local server ile çalıştırman gerekebilir."
        );
      });

    /***********************
     * 10) UTILS
     ***********************/
    function shuffleInPlace(arr){
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
  </script>
</body>
</html>
